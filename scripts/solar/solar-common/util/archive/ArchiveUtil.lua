local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__Delete = ____lualib.__TS__Delete
local __TS__StringSubstring = ____lualib.__TS__StringSubstring
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["8"] = 2,["9"] = 2,["10"] = 3,["11"] = 3,["12"] = 4,["13"] = 4,["14"] = 5,["15"] = 5,["16"] = 11,["17"] = 11,["18"] = 11,["20"] = 11,["21"] = 41,["22"] = 41,["23"] = 41,["25"] = 41,["26"] = 41,["28"] = 42,["29"] = 43,["30"] = 44,["31"] = 45,["32"] = 46,["35"] = 49,["36"] = 50,["37"] = 51,["39"] = 53,["40"] = 41,["41"] = 62,["42"] = 63,["43"] = 64,["44"] = 65,["46"] = 67,["47"] = 68,["48"] = 69,["50"] = 71,["51"] = 62,["52"] = 80,["53"] = 81,["54"] = 82,["55"] = 83,["56"] = 84,["57"] = 80,["58"] = 94,["59"] = 94,["60"] = 94,["62"] = 95,["63"] = 96,["64"] = 97,["68"] = 101,["69"] = 102,["70"] = 103,["74"] = 107,["75"] = 108,["76"] = 109,["77"] = 110,["78"] = 111,["80"] = 113,["81"] = 114,["82"] = 115,["84"] = 117,["85"] = 118,["86"] = 119,["87"] = 120,["88"] = 121,["90"] = 123,["91"] = 124,["92"] = 125,["93"] = 126,["95"] = 128,["96"] = 129,["97"] = 130,["99"] = 132,["100"] = 133,["101"] = 134,["103"] = 136,["105"] = 94,["106"] = 145,["107"] = 145,["108"] = 145,["110"] = 146,["111"] = 147,["113"] = 150,["114"] = 151,["115"] = 152,["117"] = 145,["118"] = 159,["119"] = 160,["120"] = 161,["121"] = 159,["122"] = 168,["123"] = 169,["124"] = 170,["125"] = 171,["128"] = 174,["129"] = 175,["130"] = 176,["132"] = 178,["133"] = 168,["134"] = 184,["135"] = 185,["136"] = 186,["137"] = 187,["139"] = 188,["140"] = 188,["142"] = 189,["143"] = 189,["144"] = 190,["145"] = 191,["146"] = 192,["147"] = 193,["149"] = 189,["152"] = 188,["155"] = 197,["156"] = 197,["157"] = 197,["158"] = 197,["159"] = 197,["160"] = 197,["161"] = 197,["162"] = 198,["163"] = 184,["164"] = 204,["165"] = 205,["166"] = 206,["167"] = 204,["168"] = 212,["169"] = 213,["170"] = 214,["171"] = 215,["172"] = 216,["173"] = 217,["174"] = 218,["175"] = 219,["176"] = 220,["177"] = 221,["179"] = 223,["181"] = 225,["182"] = 212,["183"] = 228,["184"] = 229,["185"] = 230,["186"] = 231,["187"] = 232,["188"] = 233,["190"] = 235,["191"] = 236,["192"] = 237,["193"] = 238,["196"] = 241,["198"] = 244,["199"] = 247,["200"] = 248,["203"] = 251,["204"] = 251,["205"] = 252,["206"] = 253,["207"] = 254,["209"] = 256,["210"] = 257,["211"] = 258,["212"] = 259,["214"] = 261,["216"] = 251,["219"] = 266,["220"] = 267,["221"] = 268,["222"] = 269,["224"] = 271,["227"] = 275,["228"] = 276,["230"] = 228,["231"] = 284,["232"] = 285,["233"] = 286,["234"] = 284,["235"] = 290,["236"] = 291,["237"] = 292,["238"] = 293,["239"] = 294,["241"] = 297,["242"] = 297,["243"] = 297,["244"] = 297,["245"] = 297,["247"] = 299,["248"] = 299,["249"] = 299,["250"] = 299,["251"] = 299,["253"] = 290,["254"] = 310,["255"] = 311,["256"] = 312,["258"] = 314,["259"] = 315,["261"] = 316,["262"] = 316,["263"] = 317,["264"] = 318,["265"] = 319,["266"] = 320,["267"] = 321,["269"] = 316,["272"] = 324,["273"] = 324,["274"] = 324,["275"] = 325,["276"] = 325,["277"] = 325,["278"] = 325,["279"] = 325,["280"] = 325,["281"] = 325,["282"] = 326,["283"] = 324,["284"] = 324,["285"] = 328,["286"] = 328,["287"] = 328,["290"] = 335,["293"] = 330,["294"] = 331,["295"] = 332,["302"] = 337,["303"] = 338,["304"] = 338,["305"] = 338,["306"] = 338,["307"] = 338,["308"] = 338,["309"] = 338,["310"] = 328,["311"] = 328,["312"] = 340,["313"] = 340,["314"] = 340,["315"] = 341,["316"] = 342,["317"] = 343,["318"] = 344,["319"] = 344,["320"] = 344,["321"] = 344,["322"] = 344,["323"] = 344,["324"] = 344,["325"] = 340,["326"] = 340,["327"] = 340,["328"] = 347,["329"] = 310,["330"] = 350,["331"] = 351,["332"] = 352,["333"] = 353,["334"] = 354,["335"] = 355,["337"] = 356,["338"] = 356,["340"] = 357,["341"] = 358,["343"] = 359,["344"] = 359,["345"] = 360,["346"] = 361,["347"] = 362,["348"] = 363,["350"] = 366,["351"] = 367,["352"] = 368,["355"] = 359,["358"] = 373,["359"] = 374,["361"] = 376,["364"] = 408,["365"] = 409,["366"] = 409,["367"] = 409,["368"] = 409,["369"] = 409,["370"] = 409,["371"] = 409,["372"] = 410,["375"] = 378,["376"] = 379,["377"] = 380,["378"] = 381,["379"] = 382,["380"] = 382,["381"] = 382,["382"] = 382,["383"] = 382,["384"] = 382,["385"] = 382,["386"] = 384,["387"] = 384,["388"] = 384,["389"] = 384,["390"] = 384,["391"] = 384,["392"] = 384,["393"] = 387,["396"] = 391,["397"] = 392,["398"] = 393,["399"] = 395,["400"] = 395,["401"] = 395,["402"] = 395,["403"] = 395,["404"] = 395,["405"] = 395,["406"] = 396,["408"] = 399,["409"] = 400,["410"] = 401,["411"] = 403,["412"] = 404,["420"] = 377,["425"] = 356,["428"] = 413,["429"] = 350,["430"] = 16,["431"] = 17,["432"] = 21,["433"] = 22,["434"] = 24,["435"] = 26,["436"] = 27,["437"] = 28,["438"] = 30,["439"] = 32,["440"] = 308});
local ____exports = {}
local ____CodecUtil = require("solar.solar-common.util.math.CodecUtil")
local CodecUtil = ____CodecUtil.default
local ____DataBase = require("solar.solar-common.common.DataBase")
local DataBase = ____DataBase.default
local ____player = require("solar.solar-common.w3ts.handles.player")
local MapPlayer = ____player.MapPlayer
local ____PlatUtil = require("solar.solar-common.util.game.PlatUtil")
local PlatUtil = ____PlatUtil.default
____exports.default = __TS__Class()
local ArchiveUtil = ____exports.default
ArchiveUtil.name = "ArchiveUtil"
function ArchiveUtil.prototype.____constructor(self)
end
function ArchiveUtil.get(self, whichPlayer, key, limitVal, limitKey)
    if limitVal == nil then
        limitVal = 0
    end
    if limitKey == nil then
        limitKey = ____exports.default.defaultLimitKey
    end
    ____exports.default:_init0()
    if limitVal > 0 then
        local sVal = limitKey and S2I(DzAPI_Map_GetServerValue(whichPlayer, limitKey)) or DzAPI_Map_GetMapLevel(whichPlayer)
        if sVal < limitVal then
            return nil
        end
    end
    local data = ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
    if not data then
        return nil
    end
    return data[key]
end
function ArchiveUtil.updateMaxNumber(self, whichPlayer, key, value)
    local oldVal = ____exports.default:get(whichPlayer, key) or 0
    if value == nil then
        return oldVal
    end
    if value > oldVal then
        ____exports.default:set(whichPlayer, key, value)
        return value
    end
    return oldVal
end
function ArchiveUtil.addNumber(self, whichPlayer, key, addValue)
    local oldVal = ____exports.default:get(whichPlayer, key) or 0
    local newVal = oldVal + addValue
    ____exports.default:set(whichPlayer, key, newVal)
    return newVal
end
function ArchiveUtil.set(self, whichPlayer, key, value, isSave)
    if isSave == nil then
        isSave = true
    end
    if not IsHandle(whichPlayer) then
        if isDebug then
            log.errorWithTraceBack()
        end
        return
    end
    if key == nil then
        if isDebug then
            log.errorWithTraceBack()
        end
        return
    end
    ____exports.default:_init0()
    local data = ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
    if not data then
        data = {}
        ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))] = data
    end
    data[key] = value
    if value == nil then
        __TS__Delete(data, key)
    end
    local bucketId = ____exports.default:_sl_getBucketId(key)
    local playerDataBucket = ____exports.default.playerDataBuckets["P" .. tostring(GetPlayerId(whichPlayer))]
    if playerDataBucket == nil then
        playerDataBucket = {}
        ____exports.default.playerDataBuckets["P" .. tostring(GetPlayerId(whichPlayer))] = playerDataBucket
    end
    local bucket = playerDataBucket[bucketId]
    if bucket == nil then
        bucket = {}
        playerDataBucket[bucketId] = bucket
    end
    bucket[key] = value
    if value == nil then
        __TS__Delete(bucket, key)
    end
    if isSave then
        if isDebug then
            print((("ArchiveUtil.set:" .. key) .. "=") .. tostring(value))
        end
        ____exports.default:_sl_saveBucket(whichPlayer, bucketId, bucket)
    end
end
function ArchiveUtil.saveAll(self, whichPlayer, ignoreWarning)
    if ignoreWarning == nil then
        ignoreWarning = false
    end
    if ignoreWarning == false then
        log.errorWithTraceBack("不推荐的用法!一次性保存所有存档可能导致崩溃丢档!")
    end
    local playerDataBucket = ____exports.default.playerDataBuckets["P" .. tostring(GetPlayerId(whichPlayer))]
    for bucketId in pairs(playerDataBucket) do
        ____exports.default:_sl_saveBucket(whichPlayer, bucketId, playerDataBucket[bucketId])
    end
end
function ArchiveUtil.getAllArchive(self, whichPlayer)
    ____exports.default:_init0()
    return ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
end
function ArchiveUtil.printAllArchive(self, whichPlayer)
    ____exports.default:_init0()
    local data = ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))]
    if not data then
        return
    end
    print(("========打印玩家" .. tostring(GetPlayerId(whichPlayer) + 1)) .. "的存档 开始========")
    for dataKey in pairs(data) do
        print(((dataKey .. "=[") .. tostring(data[dataKey])) .. "]")
    end
    print(("========打印玩家" .. tostring(GetPlayerId(whichPlayer) + 1)) .. "的存档 结束========")
end
function ArchiveUtil.clearAllArchive(self, whichPlayer)
    ____exports.default:_init0()
    ____exports.default.playerDatas["P" .. tostring(GetPlayerId(whichPlayer))] = {}
    ____exports.default.playerDataBuckets["P" .. tostring(GetPlayerId(whichPlayer))] = {}
    do
        local bidNo = 0
        while bidNo <= ____exports.default.bucketMax do
            do
                local i = 0
                while i < ____exports.default.ArchiveKeyCountMax do
                    local key = (("B_" .. tostring(bidNo)) .. "_") .. tostring(i)
                    local serverValue = DzAPI_Map_GetServerValue(whichPlayer, key)
                    if serverValue and #serverValue > 0 then
                        DzAPI_Map_FlushStoredMission(whichPlayer, key)
                    end
                    i = i + 1
                end
            end
            bidNo = bidNo + 1
        end
    end
    DisplayTimedTextToPlayer(
        whichPlayer,
        0,
        0,
        10,
        "|cffff0000已清理全部存档!请重开游戏查看效果!"
    )
    print("已清理全部存档!")
end
function ArchiveUtil.getCurrentArchiveKeyMax(self, whichPlayer)
    ____exports.default:_init0()
    return ____exports.default._sl_playerCurrentArchiveKeyMax["P" .. tostring(GetPlayerId(whichPlayer))] or 0
end
function ArchiveUtil.getCurrentArchiveKeyMaxInfo(self, whichPlayer)
    local used = ____exports.default:getCurrentArchiveKeyMax(whichPlayer)
    local p = math.ceil(used * 100 / ____exports.default.ArchiveKeyCountMax)
    local info = ("(" .. tostring(p)) .. "%)"
    if p > 90 then
        info = "|cffff0000" .. info
    elseif p > 80 then
        info = "|cffe24700" .. info
    elseif p > 70 then
        info = "|cffdb7835" .. info
    else
        info = "|cff0a8f17" .. info
    end
    return ((tostring(used) .. "/") .. tostring(____exports.default.ArchiveKeyCountMax)) .. info
end
function ArchiveUtil._sl_saveBucket(self, whichPlayer, bucketId, bucket)
    local dataJsonStr = JSON:stringify(bucket)
    local userIdTag = ____exports.default:_sl_getUserIdTag(whichPlayer)
    dataJsonStr = userIdTag .. __TS__StringSubstring(dataJsonStr, 1, #dataJsonStr - 1)
    if ____exports.default.encrypt then
        dataJsonStr = CodecUtil:saesEncode(dataJsonStr, gameName .. ____exports.default.salt)
    end
    local dataJsonStrLength = #dataJsonStr
    local keyLength = math.floor(dataJsonStrLength / 64) + 1
    if keyLength > ____exports.default.ArchiveKeyCountMax then
        log.errorWithTraceBack((("存档栏位大小超过" .. tostring(____exports.default.ArchiveKeyCountMax)) .. "！") .. tostring(keyLength))
        return
    end
    local oneData = nil
    --- 当存档位需要多个key时  使用批量保存  以保证数据完整性
    local useBatch = not isDebug
    if useBatch then
        KKApiBeginBatchSaveArchive(whichPlayer)
    end
    do
        local i = 0
        while i < keyLength do
            local endIndex = (i + 1) * 64
            if endIndex > dataJsonStrLength then
                endIndex = dataJsonStrLength
            end
            oneData = __TS__StringSubstring(dataJsonStr, i * 64, endIndex)
            local key = (bucketId .. "_") .. tostring(i)
            if useBatch then
                KKApiAddBatchSaveArchive(whichPlayer, key, oneData, true)
            else
                DzAPI_Map_SaveServerValue(whichPlayer, key, oneData)
            end
            i = i + 1
        end
    end
    if #oneData == 64 then
        local key = (bucketId .. "_") .. tostring(keyLength)
        if useBatch then
            KKApiAddBatchSaveArchive(whichPlayer, key, "", true)
        else
            DzAPI_Map_FlushStoredMission(whichPlayer, key)
        end
    end
    if useBatch then
        KKApiEndBatchSaveArchive(whichPlayer, false)
    end
end
function ArchiveUtil._sl_getBucketId(self, key)
    local index = math.abs(StringHash(key)) % ____exports.default.bucketMax
    return "B_" .. tostring(index)
end
function ArchiveUtil._sl_getUserIdTag(self, p)
    if GetUserId then
        local uid = MapPlayer:fromHandle(p).userId
        if uid == -1 then
            log.errorWithTraceBack("请等待内置userId(用户id)同步完成！(为了解决玩家名更改后靠userId判断是否是自己的存档)")
        end
        return __TS__StringSubstring(
            CodecUtil:sBase64Encode("SL" .. tostring(uid)),
            0,
            2
        )
    else
        return __TS__StringSubstring(
            CodecUtil:sBase64Encode("SL" .. GetPlayerName(p)),
            0,
            2
        )
    end
end
function ArchiveUtil._init0(self)
    if ____exports.default.isInit then
        return true
    end
    ____exports.default.isInit = true
    ____exports.default._init_time = time
    do
        local i = 0
        while i < bj_MAX_PLAYER_SLOTS do
            local tempPlayer = Player(i)
            if GetPlayerController(tempPlayer) == MAP_CONTROL_USER and GetPlayerSlotState(tempPlayer) == PLAYER_SLOT_STATE_PLAYING then
                local playerAllArchiveData = ____exports.default:_init0_onePlayer(tempPlayer)
                ____exports.default.playerDatas["P" .. tostring(i)] = playerAllArchiveData
                DataBase:getPlayerSolarData(tempPlayer, true)._tt = playerAllArchiveData._tt or 0
            end
            i = i + 1
        end
    end
    se:onPlayerChat(
        "-sl-ia",
        function(e)
            DisplayTimedTextToPlayer(
                e.triggerPlayer,
                0,
                0,
                10,
                ____exports.default:getCurrentArchiveKeyMaxInfo(e.triggerPlayer)
            )
            ____exports.default:printAllArchive(e.triggerPlayer)
        end
    )
    se:onPlayerChat(
        "-清空存档",
        function(e)
            do
                local function ____catch(e)
                    print(e)
                end
                local ____try, ____hasReturned = pcall(function()
                    for ____, allArchiveKey in ipairs(PlatUtil.allArchiveKeys) do
                        DzAPI_Map_SaveServerValue(e.triggerPlayer, allArchiveKey, "")
                        DzAPI_Map_FlushStoredMission(e.triggerPlayer, allArchiveKey)
                    end
                end)
                if not ____try then
                    ____catch(____hasReturned)
                end
            end
            ____exports.default:clearAllArchive(e.triggerPlayer)
            DisplayTimedTextToPlayer(
                e.triggerPlayer,
                0,
                0,
                10,
                "清空存档完毕!"
            )
        end
    )
    se:onPlayerChat(
        "-sla-remove-",
        function(e)
            local key = __TS__StringSubstring(e.eventPlayerChatString, 12)
            local serverValue = DzAPI_Map_GetServerValue(e.triggerPlayer, key)
            DzAPI_Map_FlushStoredMission(e.triggerPlayer, key)
            DisplayTimedTextToPlayer(
                e.triggerPlayer,
                0,
                0,
                10,
                (("|cffff0000移除存档:" .. key) .. ":") .. tostring(serverValue)
            )
        end,
        false
    )
    return true
end
function ArchiveUtil._init0_onePlayer(self, tempPlayer)
    local data = {}
    local pId = GetPlayerId(tempPlayer)
    local userIdTag = ____exports.default:_sl_getUserIdTag(tempPlayer)
    local buckets = {}
    ____exports.default.playerDataBuckets["P" .. tostring(pId)] = buckets
    do
        local bIndex = 0
        while bIndex < ____exports.default.bucketMax do
            do
                local bucketId = "B_" .. tostring(bIndex)
                local bucketDataJsonStr = ""
                do
                    local i = 0
                    while i < ____exports.default.ArchiveKeyCountMax do
                        local key = (bucketId .. "_") .. tostring(i)
                        local serverValue = DzAPI_Map_GetServerValue(tempPlayer, key)
                        if serverValue and #serverValue > 0 then
                            bucketDataJsonStr = bucketDataJsonStr .. serverValue
                        end
                        if serverValue == nil or #serverValue < 64 then
                            local keyMax = ____exports.default._sl_playerCurrentArchiveKeyMax["P" .. tostring(pId)] or 0
                            ____exports.default._sl_playerCurrentArchiveKeyMax["P" .. tostring(pId)] = keyMax + i
                            break
                        end
                        i = i + 1
                    end
                end
                if #bucketDataJsonStr < 4 then
                    goto __continue76
                end
                local continueFlag = false
                do
                    local function ____catch(e)
                        print("存档Json格式解析出错!")
                        DisplayTimedTextToPlayer(
                            GetLocalPlayer(),
                            0,
                            0,
                            60,
                            "存档格式解析出错！请不要私自修改存档数据！"
                        )
                        print(("需要解析的Json字符串为[" .. bucketDataJsonStr) .. "]")
                    end
                    local ____try, ____hasReturned, ____returnValue = pcall(function()
                        if ____exports.default.encrypt then
                            bucketDataJsonStr = CodecUtil:saesDecode(bucketDataJsonStr, gameName .. ____exports.default.salt)
                            if bucketDataJsonStr == nil then
                                print("存档Json格式解析出错!")
                                DisplayTimedTextToPlayer(
                                    GetLocalPlayer(),
                                    0,
                                    0,
                                    60,
                                    ((("|cffff0000玩家" .. tostring(pId + 1)) .. ":") .. GetPlayerName(tempPlayer)) .. " 的存档格式解析出错！"
                                )
                                DisplayTimedTextToPlayer(
                                    tempPlayer,
                                    0,
                                    0,
                                    60,
                                    ("请不要私自修改存档数据或保存存档时终止游戏！" .. "异常的bucketId=") .. bucketId
                                )
                                continueFlag = true
                            end
                        end
                        if continueFlag == false then
                            local bucketUserIdTag = __TS__StringSubstring(bucketDataJsonStr, 0, 2)
                            if ____exports.default.verifyPlayerName and userIdTag ~= bucketUserIdTag then
                                DisplayTimedTextToPlayer(
                                    tempPlayer,
                                    0,
                                    0,
                                    20,
                                    "|cffff0000存档玩家名验证失败!请重开游戏或使用空存档继续游玩!"
                                )
                                return true, data
                            end
                            bucketDataJsonStr = ("{" .. __TS__StringSubstring(bucketDataJsonStr, 2)) .. "}"
                            local bucketData = JSON:parse(bucketDataJsonStr)
                            buckets[bucketId] = bucketData
                            for bucketDataKey in pairs(bucketData) do
                                data[bucketDataKey] = bucketData[bucketDataKey]
                            end
                        end
                    end)
                    if not ____try then
                        ____hasReturned, ____returnValue = ____catch(____hasReturned)
                    end
                    if ____hasReturned then
                        return ____returnValue
                    end
                end
            end
            ::__continue76::
            bIndex = bIndex + 1
        end
    end
    return data
end
ArchiveUtil.encrypt = true
ArchiveUtil.verifyPlayerName = not isDebug
ArchiveUtil.ArchiveKeyCountMax = 120
ArchiveUtil.salt = "s_z_b_s_q_j"
ArchiveUtil.defaultLimitKey = nil
ArchiveUtil.playerDatas = {}
ArchiveUtil._sl_playerCurrentArchiveKeyMax = {}
ArchiveUtil._init_time = -1
ArchiveUtil.playerDataBuckets = {}
ArchiveUtil.bucketMax = 100
ArchiveUtil.isInit = false
return ____exports
