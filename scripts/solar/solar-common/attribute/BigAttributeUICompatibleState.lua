local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__New = ____lualib.__TS__New
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["7"] = 1,["8"] = 1,["9"] = 2,["10"] = 2,["11"] = 3,["12"] = 3,["13"] = 4,["14"] = 4,["15"] = 5,["16"] = 5,["17"] = 6,["18"] = 6,["19"] = 7,["20"] = 7,["21"] = 8,["22"] = 8,["23"] = 9,["24"] = 9,["25"] = 10,["26"] = 10,["27"] = 11,["28"] = 11,["29"] = 12,["30"] = 12,["31"] = 14,["32"] = 15,["33"] = 16,["34"] = 16,["35"] = 16,["37"] = 48,["38"] = 49,["41"] = 52,["42"] = 52,["43"] = 52,["44"] = 53,["45"] = 54,["46"] = 56,["47"] = 57,["48"] = 58,["49"] = 52,["50"] = 52,["51"] = 47,["52"] = 63,["53"] = 64,["54"] = 64,["55"] = 64,["56"] = 64,["57"] = 64,["58"] = 64,["59"] = 64,["60"] = 65,["61"] = 65,["62"] = 65,["63"] = 65,["64"] = 65,["65"] = 65,["66"] = 65,["67"] = 68,["68"] = 69,["69"] = 70,["72"] = 73,["73"] = 74,["75"] = 76,["77"] = 80,["78"] = 81,["79"] = 82,["80"] = 83,["81"] = 84,["82"] = 85,["83"] = 86,["84"] = 87,["86"] = 89,["88"] = 91,["89"] = 93,["90"] = 94,["91"] = 95,["92"] = 96,["93"] = 97,["94"] = 98,["96"] = 101,["97"] = 102,["98"] = 103,["99"] = 104,["100"] = 106,["101"] = 107,["102"] = 108,["103"] = 109,["104"] = 110,["106"] = 112,["108"] = 114,["109"] = 114,["110"] = 114,["111"] = 114,["113"] = 118,["114"] = 119,["115"] = 120,["116"] = 121,["117"] = 122,["118"] = 123,["119"] = 124,["120"] = 126,["122"] = 129,["124"] = 131,["125"] = 132,["126"] = 133,["127"] = 134,["128"] = 135,["131"] = 138,["132"] = 139,["134"] = 141,["135"] = 143,["136"] = 144,["137"] = 145,["138"] = 146,["139"] = 147,["141"] = 149,["142"] = 151,["143"] = 152,["144"] = 153,["145"] = 154,["146"] = 155,["148"] = 158,["149"] = 160,["150"] = 161,["151"] = 162,["152"] = 163,["153"] = 164,["155"] = 166,["156"] = 63,["157"] = 173,["158"] = 184,["159"] = 185,["160"] = 186,["161"] = 193,["162"] = 194,["163"] = 195,["164"] = 197,["165"] = 198,["166"] = 199,["167"] = 201,["168"] = 203,["169"] = 204,["170"] = 206,["171"] = 208,["172"] = 209,["173"] = 211,["174"] = 212,["175"] = 213,["176"] = 213,["177"] = 213,["178"] = 213,["179"] = 213,["180"] = 213,["181"] = 213,["182"] = 213,["183"] = 216,["184"] = 218,["185"] = 218,["186"] = 218,["187"] = 218,["188"] = 218,["189"] = 218,["190"] = 218,["191"] = 218,["192"] = 220,["193"] = 222,["194"] = 223,["195"] = 223,["196"] = 223,["197"] = 223,["198"] = 223,["199"] = 223,["200"] = 223,["201"] = 223,["202"] = 225,["203"] = 230,["204"] = 231,["205"] = 232,["206"] = 233,["207"] = 235,["208"] = 236,["209"] = 237,["210"] = 238,["211"] = 240,["212"] = 241,["213"] = 242,["214"] = 244,["215"] = 245,["216"] = 246,["217"] = 173,["218"] = 255,["219"] = 259,["220"] = 260,["221"] = 261,["222"] = 261,["223"] = 261,["224"] = 261,["225"] = 261,["226"] = 261,["227"] = 261,["228"] = 261,["230"] = 263,["231"] = 264,["232"] = 265,["233"] = 265,["234"] = 265,["235"] = 265,["236"] = 265,["237"] = 265,["238"] = 265,["239"] = 265,["241"] = 273,["242"] = 274,["243"] = 274,["244"] = 274,["245"] = 274,["246"] = 274,["247"] = 274,["248"] = 274,["249"] = 274,["250"] = 276,["251"] = 277,["252"] = 277,["253"] = 277,["254"] = 277,["255"] = 277,["256"] = 277,["257"] = 277,["258"] = 277,["259"] = 279,["260"] = 280,["261"] = 280,["262"] = 280,["263"] = 280,["264"] = 280,["265"] = 280,["266"] = 280,["267"] = 280,["268"] = 284,["269"] = 285,["270"] = 285,["271"] = 285,["272"] = 285,["273"] = 285,["274"] = 285,["275"] = 285,["276"] = 285,["277"] = 288,["278"] = 289,["279"] = 289,["280"] = 289,["281"] = 289,["282"] = 289,["283"] = 289,["284"] = 289,["285"] = 289,["286"] = 291,["287"] = 292,["288"] = 292,["289"] = 292,["290"] = 292,["291"] = 292,["292"] = 292,["293"] = 292,["294"] = 292,["295"] = 294,["296"] = 295,["297"] = 295,["298"] = 295,["299"] = 295,["300"] = 295,["301"] = 295,["302"] = 295,["303"] = 295,["304"] = 297,["305"] = 298,["306"] = 298,["307"] = 298,["308"] = 298,["309"] = 298,["310"] = 298,["311"] = 300,["312"] = 301,["313"] = 301,["314"] = 301,["315"] = 301,["316"] = 301,["317"] = 301,["318"] = 303,["319"] = 304,["320"] = 304,["321"] = 304,["322"] = 304,["323"] = 304,["324"] = 304,["325"] = 306,["326"] = 307,["327"] = 307,["328"] = 307,["329"] = 307,["330"] = 307,["331"] = 307,["332"] = 255,["333"] = 310,["334"] = 310,["335"] = 310,["337"] = 311,["338"] = 312,["339"] = 313,["340"] = 314,["341"] = 315,["342"] = 316,["343"] = 317,["344"] = 310,["345"] = 17});
local ____exports = {}
local ____UnitUtil = require("solar.solar-common.util.unit.UnitUtil")
local UnitUtil = ____UnitUtil.default
local ____NativeFrameUtil = require("solar.solar-common.util.frame.NativeFrameUtil")
local NativeFrameUtil = ____NativeFrameUtil.default
local ____TextUtil = require("solar.solar-common.util.text.TextUtil")
local TextUtil = ____TextUtil.default
local ____trigger = require("solar.solar-common.w3ts.handles.trigger")
local Trigger = ____trigger.Trigger
local ____ColorStr = require("solar.solar-common.constant.ColorStr")
local ColorStr = ____ColorStr.default
local ____frame = require("solar.solar-common.w3ts.handles.frame")
local Frame = ____frame.Frame
local ____BaseUtil = require("solar.solar-common.util.BaseUtil")
local BaseUtil = ____BaseUtil.default
local ____SelectUtil = require("solar.solar-common.util.unit.SelectUtil")
local SelectUtil = ____SelectUtil.default
local ____HeroUtil = require("solar.solar-common.util.unit.HeroUtil")
local HeroUtil = ____HeroUtil.default
local ____ExFrameApiUtil = require("solar.solar-common.util.frame.ExFrameApiUtil")
local ExFrameApiUtil = ____ExFrameApiUtil.default
local ____SingletonUtil = require("solar.solar-common.util.lang.SingletonUtil")
local SingletonUtil = ____SingletonUtil.default
local ____UnitStateUtil = require("solar.solar-common.util.unit.UnitStateUtil")
local UnitStateUtil = ____UnitStateUtil.default
local textFont = "Fonts\\dfst-m3u.ttf"
local textHeight = 0.01
____exports.default = __TS__Class()
local BigAttributeUICompatibleState = ____exports.default
BigAttributeUICompatibleState.name = "BigAttributeUICompatibleState"
function BigAttributeUICompatibleState.prototype.____constructor(self)
    if SingletonUtil:notFirstTime(____exports.default) then
        print("不能重复new BigAttributeUICompatibleState()")
        return
    end
    BaseUtil.runLater(
        0.1,
        function()
            self:moveNativeFrame()
            self:createUI()
            local trigger = __TS__New(Trigger)
            trigger:registerTimerEvent(0.1, true)
            trigger:addAction(self.refreshSolarUI)
        end
    )
end
function BigAttributeUICompatibleState.prototype.refreshSolarUI()
    DzFrameSetText(
        ____exports.default.goldFrame,
        TextUtil:toCnUnit(GetPlayerState(
            GetLocalPlayer(),
            PLAYER_STATE_RESOURCE_GOLD
        ))
    )
    DzFrameSetText(
        ____exports.default.lumberFrame,
        TextUtil:toCnUnit(GetPlayerState(
            GetLocalPlayer(),
            PLAYER_STATE_RESOURCE_LUMBER
        ))
    )
    local unit = SelectUtil.getRealSelectUnit()
    if not IsHandle(unit) then
        ____exports.default:showSolarUI(false)
        return
    end
    if HeroUtil:isHero(unit) then
        ____exports.default:showSolarUI(true, true)
    else
        ____exports.default:showSolarUI(true, false)
    end
    local life = GetUnitState(unit, UNIT_STATE_LIFE)
    local maxLife = GetUnitState(unit, UNIT_STATE_MAX_LIFE)
    local bfbLife = R2I(life * 100 / maxLife)
    local hpText = ((TextUtil:toCnUnit(life) .. "/") .. TextUtil:toCnUnit(maxLife)) .. ("(" .. tostring(bfbLife)) .. ")%"
    if bfbLife > 80 then
        hpText = ColorStr.green .. hpText
    elseif bfbLife > 40 then
        hpText = ColorStr.yellow .. hpText
    else
        hpText = ColorStr.red .. hpText
    end
    DzFrameSetText(____exports.default.hpFrame, hpText)
    local mana = GetUnitState(unit, UNIT_STATE_MANA)
    local maxMana = GetUnitState(unit, UNIT_STATE_MAX_MANA)
    if maxMana and maxMana > 0 then
        local bfbMana = tostring(R2I(mana * 100 / maxMana)) .. "%"
        local manaText = ((TextUtil:toCnUnit(mana) .. " / ") .. TextUtil:toCnUnit(maxMana)) .. ("(" .. bfbMana) .. ")"
        DzFrameSetText(____exports.default.manaFrame, manaText)
    end
    local aAttack = GetUnitState(unit, UnitStateDamageMix)
    if ____exports.default.config.isShowGreenAttack then
        local lvAttack = GetUnitState(unit, UnitStateDamageBonus)
        local bAttack = aAttack - lvAttack
        local blText = TextUtil:toCnUnit(bAttack)
        if lvAttack > 0 then
            blText = (((blText .. "  ") .. ColorStr.green) .. "+") .. TextUtil:toCnUnit(lvAttack)
        elseif lvAttack < -20 then
            blText = ((blText .. "  ") .. ColorStr.red) .. TextUtil:toCnUnit(lvAttack)
        end
        DzFrameSetText(____exports.default.attackValueFrame, blText)
    else
        DzFrameSetText(
            ____exports.default.attackValueFrame,
            TextUtil:toCnUnit(aAttack)
        )
    end
    local armorText = nil
    if UnitStateUtil:isInvulnerable(unit) then
        armorText = "|cffff0000无敌的"
    elseif ____exports.default.config.isShowGreenArmor then
        local extraDef = UnitUtil.getExtraDef(unit)
        local baseDef = GetUnitState(unit, UnitStateArmor) - extraDef
        if baseDef < 1000000 then
            armorText = TextUtil:toCnUnit(math.floor(baseDef + 0.5))
        else
            armorText = TextUtil:toCnUnit(baseDef)
        end
        local greenArmorText = TextUtil:toCnUnit(extraDef > 1000000 and extraDef or math.floor(extraDef + 0.5))
        if extraDef > 0 then
            armorText = (((tostring(armorText) .. "  ") .. ColorStr.green) .. "+") .. greenArmorText
        elseif extraDef < 0 then
            armorText = ((tostring(armorText) .. "  ") .. ColorStr.red) .. greenArmorText
        end
    else
        local allDef = GetUnitState(unit, UnitStateArmor)
        armorText = TextUtil:toCnUnit(allDef > 1000000 and allDef or math.floor(allDef + 0.5))
    end
    DzFrameSetText(____exports.default.armorValueFrame, armorText)
    local bStr = GetHeroStr(unit, false)
    local blStr = GetHeroStr(unit, true)
    local strText = TextUtil:toCnUnit(bStr)
    if bStr ~= blStr then
        strText = (((strText .. "  ") .. ColorStr.green) .. "+") .. TextUtil:toCnUnit(blStr - bStr)
    end
    DzFrameSetText(____exports.default.heroStrValueFrame, strText)
    local bAgi = GetHeroAgi(unit, false)
    local blAgi = GetHeroAgi(unit, true)
    local agiText = TextUtil:toCnUnit(bAgi)
    if bAgi ~= blAgi then
        agiText = (((agiText .. "  ") .. ColorStr.green) .. "+") .. TextUtil:toCnUnit(blAgi - bAgi)
    end
    DzFrameSetText(____exports.default.heroAgiValueFrame, agiText)
    local bInt = GetHeroInt(unit, false)
    local blInt = GetHeroInt(unit, true)
    local intText = TextUtil:toCnUnit(bInt)
    if bInt ~= blInt then
        intText = (((intText .. "  ") .. ColorStr.green) .. "+") .. TextUtil:toCnUnit(blInt - bInt)
    end
    DzFrameSetText(____exports.default.heroIntValueFrame, intText)
end
function BigAttributeUICompatibleState.prototype.createUI(self)
    ____exports.default.unitUIContainer = ExFrameApiUtil:createBaseFrameInSimpleFrame(NativeFrameUtil:getUnitStatePanel())
    ____exports.default.unitArmorContainer = ExFrameApiUtil:createBaseFrameInSimpleFrame(DzSimpleFrameFindByName("SimpleInfoPanelIconArmor", 0))
    ____exports.default.heroUIContainer = ExFrameApiUtil:createBaseFrameInSimpleFrame(NativeFrameUtil:getHeroStatePanel())
    ____exports.default.goldFrame = __TS__New(Frame, "TEXT").current
    DzFrameSetAbsolutePoint(____exports.default.goldFrame, FRAMEPOINT_TOPRIGHT, 0.533, 0.595)
    DzFrameSetFont(____exports.default.goldFrame, textFont, textHeight, 0)
    ____exports.default.lumberFrame = __TS__New(Frame, "TEXT").current
    DzFrameSetAbsolutePoint(____exports.default.lumberFrame, FRAMEPOINT_TOPRIGHT, 0.621, 0.595)
    DzFrameSetFont(____exports.default.lumberFrame, textFont, textHeight, 0)
    ____exports.default.attackValueFrame = __TS__New(Frame, "TEXT", nil, ____exports.default.unitUIContainer).current
    DzFrameSetAbsolutePoint(____exports.default.attackValueFrame, FRAMEPOINT_TOPLEFT, 0.35, 0.07)
    DzFrameSetFont(____exports.default.attackValueFrame, textFont, textHeight, 0)
    ____exports.default.armorValueFrame = __TS__New(Frame, "TEXT", nil, ____exports.default.unitArmorContainer).current
    DzFrameSetAbsolutePoint(____exports.default.armorValueFrame, FRAMEPOINT_TOPLEFT, 0.35, 0.036)
    DzFrameSetFont(____exports.default.armorValueFrame, textFont, textHeight, 0)
    ____exports.default.heroStrValueFrame = __TS__New(Frame, "TEXT", nil, ____exports.default.heroUIContainer).current
    DzFrameSetFont(____exports.default.heroStrValueFrame, textFont, textHeight, 0)
    DzFrameSetPoint(
        ____exports.default.heroStrValueFrame,
        FRAMEPOINT_TOPLEFT,
        NativeFrameUtil:getHeroStrLabel(),
        FRAMEPOINT_BOTTOMLEFT,
        0.005,
        0
    )
    ____exports.default.heroAgiValueFrame = __TS__New(Frame, "TEXT", nil, ____exports.default.heroUIContainer).current
    DzFrameSetPoint(
        ____exports.default.heroAgiValueFrame,
        FRAMEPOINT_TOPLEFT,
        NativeFrameUtil:getHeroAgiLabel(),
        FRAMEPOINT_BOTTOMLEFT,
        0.005,
        0
    )
    DzFrameSetFont(____exports.default.heroAgiValueFrame, textFont, textHeight, 0)
    ____exports.default.heroIntValueFrame = __TS__New(Frame, "TEXT", nil, ____exports.default.heroUIContainer).current
    DzFrameSetPoint(
        ____exports.default.heroIntValueFrame,
        FRAMEPOINT_TOPLEFT,
        NativeFrameUtil:getHeroIntLabel(),
        FRAMEPOINT_BOTTOMLEFT,
        0.005,
        0
    )
    DzFrameSetFont(____exports.default.heroIntValueFrame, textFont, textHeight, 0)
    ____exports.default.hpBackdropFrame = __TS__New(Frame, "BACKDROP", nil, ____exports.default.unitArmorContainer).current
    DzFrameSetTexture(____exports.default.hpBackdropFrame, "UI\\Glues\\SinglePlayer\\HumanCampaign3D\\Black32.blp", 0)
    DzFrameSetSize(____exports.default.hpBackdropFrame, 0.076, 0.012)
    DzFrameSetAbsolutePoint(____exports.default.hpBackdropFrame, FRAMEPOINT_CENTER, 0.254, 0.023)
    ____exports.default.manaBackdropFrame = __TS__New(Frame, "BACKDROP", nil, ____exports.default.unitArmorContainer).current
    DzFrameSetSize(____exports.default.manaBackdropFrame, 0.076, 0.012)
    DzFrameSetTexture(____exports.default.manaBackdropFrame, "UI\\Glues\\SinglePlayer\\HumanCampaign3D\\Black32.blp", 0)
    DzFrameSetAbsolutePoint(____exports.default.manaBackdropFrame, FRAMEPOINT_CENTER, 0.254, 0.009)
    ____exports.default.hpFrame = __TS__New(Frame, "TEXT", nil, ____exports.default.unitArmorContainer).current
    DzFrameSetFont(____exports.default.hpFrame, textFont, textHeight, 0)
    DzFrameSetAbsolutePoint(____exports.default.hpFrame, FRAMEPOINT_CENTER, 0.254, 0.023)
    ____exports.default.manaFrame = __TS__New(Frame, "TEXT", nil, ____exports.default.unitArmorContainer).current
    DzFrameSetAbsolutePoint(____exports.default.manaFrame, FRAMEPOINT_CENTER, 0.254, 0.009)
    DzFrameSetFont(____exports.default.manaFrame, textFont, textHeight, 0)
end
function BigAttributeUICompatibleState.prototype.moveNativeFrame(self)
    if ____exports.default.config.removeAttackIcon then
        DzFrameClearAllPoints(NativeFrameUtil:getUnitAttackIcon(0))
        DzFrameSetPoint(
            NativeFrameUtil:getUnitAttackIcon(0),
            4,
            DzGetGameUI(),
            4,
            0,
            -0.5
        )
    end
    if ____exports.default.config.removeArmorIcon then
        DzFrameClearAllPoints(NativeFrameUtil:getUnitArmorIcon())
        DzFrameSetPoint(
            NativeFrameUtil:getUnitArmorIcon(),
            4,
            DzGetGameUI(),
            4,
            0,
            -0.5
        )
    end
    DzFrameClearAllPoints(NativeFrameUtil:getGoldText())
    DzFrameSetPoint(
        NativeFrameUtil:getGoldText(),
        4,
        DzGetGameUI(),
        4,
        0,
        -0.5
    )
    DzFrameClearAllPoints(NativeFrameUtil:getLumberText())
    DzFrameSetPoint(
        NativeFrameUtil:getLumberText(),
        4,
        DzGetGameUI(),
        4,
        0,
        -0.5
    )
    DzFrameClearAllPoints(NativeFrameUtil:getUnitAttackValue(0))
    DzFrameSetPoint(
        NativeFrameUtil:getUnitAttackValue(0),
        4,
        DzGetGameUI(),
        4,
        0,
        -0.5
    )
    DzFrameClearAllPoints(NativeFrameUtil:getUnitArmorValue())
    DzFrameSetPoint(
        NativeFrameUtil:getUnitArmorValue(),
        4,
        DzGetGameUI(),
        4,
        0,
        -0.5
    )
    DzFrameClearAllPoints(NativeFrameUtil:getHeroStrValue())
    DzFrameSetPoint(
        NativeFrameUtil:getHeroStrValue(),
        4,
        DzGetGameUI(),
        4,
        0,
        -0.5
    )
    DzFrameClearAllPoints(NativeFrameUtil:getHeroAgiValue())
    DzFrameSetPoint(
        NativeFrameUtil:getHeroAgiValue(),
        4,
        DzGetGameUI(),
        4,
        0,
        -0.5
    )
    DzFrameClearAllPoints(NativeFrameUtil:getHeroIntValue())
    DzFrameSetPoint(
        NativeFrameUtil:getHeroIntValue(),
        4,
        DzGetGameUI(),
        4,
        0,
        -0.5
    )
    DzFrameClearAllPoints(NativeFrameUtil:getUnitAttackLabel(0))
    DzFrameSetAbsolutePoint(
        NativeFrameUtil:getUnitAttackLabel(0),
        FRAMEPOINT_TOPLEFT,
        0.34,
        0.08
    )
    DzFrameClearAllPoints(NativeFrameUtil:getUnitArmorLabel())
    DzFrameSetAbsolutePoint(
        NativeFrameUtil:getUnitArmorLabel(),
        FRAMEPOINT_TOPLEFT,
        0.34,
        0.048
    )
    DzFrameClearAllPoints(NativeFrameUtil:getHeroAgiLabel())
    DzFrameSetAbsolutePoint(
        NativeFrameUtil:getHeroAgiLabel(),
        FRAMEPOINT_TOPLEFT,
        0.44,
        0.06
    )
    DzFrameClearAllPoints(NativeFrameUtil:getHeroIntLabel())
    DzFrameSetAbsolutePoint(
        NativeFrameUtil:getHeroIntLabel(),
        FRAMEPOINT_TOPLEFT,
        0.44,
        0.04
    )
end
function BigAttributeUICompatibleState.showSolarUI(self, showAttackAndArmor, showHeroAtts)
    if showHeroAtts == nil then
        showHeroAtts = showAttackAndArmor
    end
    DzFrameShow(____exports.default.hpFrame, showAttackAndArmor)
    DzFrameShow(____exports.default.manaFrame, showAttackAndArmor)
    DzFrameShow(____exports.default.attackValueFrame, showAttackAndArmor)
    DzFrameShow(____exports.default.armorValueFrame, showAttackAndArmor)
    DzFrameShow(____exports.default.heroStrValueFrame, showHeroAtts)
    DzFrameShow(____exports.default.heroAgiValueFrame, showHeroAtts)
    DzFrameShow(____exports.default.heroIntValueFrame, showHeroAtts)
end
BigAttributeUICompatibleState.config = {isShowGreenAttack = false, isShowGreenArmor = false, removeAttackIcon = true, removeArmorIcon = true}
return ____exports
