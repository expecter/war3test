local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["6"] = 1,["7"] = 1,["8"] = 2,["9"] = 2,["10"] = 3,["11"] = 3,["12"] = 4,["13"] = 4,["14"] = 5,["15"] = 5,["16"] = 6,["17"] = 6,["18"] = 7,["19"] = 7,["20"] = 8,["21"] = 8,["37"] = 29,["38"] = 30,["39"] = 31,["40"] = 31,["41"] = 31,["43"] = 35,["44"] = 36,["47"] = 39,["48"] = 40,["49"] = 41,["50"] = 42,["51"] = 43,["52"] = 34,["53"] = 51,["54"] = 53,["55"] = 54,["56"] = 55,["57"] = 56,["58"] = 56,["59"] = 56,["60"] = 56,["61"] = 56,["62"] = 56,["63"] = 56,["64"] = 56,["65"] = 56,["66"] = 56,["67"] = 54,["68"] = 51,["69"] = 62,["70"] = 64,["71"] = 65,["72"] = 66,["75"] = 69,["76"] = 69,["77"] = 69,["78"] = 69,["79"] = 69,["80"] = 71,["81"] = 73,["82"] = 74,["83"] = 75,["85"] = 65,["86"] = 79,["87"] = 80,["88"] = 81,["91"] = 84,["92"] = 84,["93"] = 84,["94"] = 84,["95"] = 84,["96"] = 86,["97"] = 80,["98"] = 89,["99"] = 90,["100"] = 91,["103"] = 94,["104"] = 94,["105"] = 94,["106"] = 94,["107"] = 94,["108"] = 96,["109"] = 99,["110"] = 100,["112"] = 90,["113"] = 105,["114"] = 106,["115"] = 107,["116"] = 108,["118"] = 110,["119"] = 110,["120"] = 111,["121"] = 112,["123"] = 114,["124"] = 106,["125"] = 116,["126"] = 117,["127"] = 118,["128"] = 119,["130"] = 121,["131"] = 121,["132"] = 122,["133"] = 123,["135"] = 125,["136"] = 117,["137"] = 127,["138"] = 128,["139"] = 129,["140"] = 130,["142"] = 132,["143"] = 132,["144"] = 133,["145"] = 134,["147"] = 136,["148"] = 128,["149"] = 62,["150"] = 144,["151"] = 146,["152"] = 147,["153"] = 148,["156"] = 152,["157"] = 153,["158"] = 153,["159"] = 153,["160"] = 153,["161"] = 153,["162"] = 154,["163"] = 155,["164"] = 156,["165"] = 156,["166"] = 156,["167"] = 156,["168"] = 156,["169"] = 157,["170"] = 158,["171"] = 159,["172"] = 160,["174"] = 162,["175"] = 164,["176"] = 164,["177"] = 164,["178"] = 164,["179"] = 164,["180"] = 165,["182"] = 167,["184"] = 169,["185"] = 170,["186"] = 171,["188"] = 173,["189"] = 174,["190"] = 174,["191"] = 174,["192"] = 174,["193"] = 174,["194"] = 175,["196"] = 177,["198"] = 179,["199"] = 180,["200"] = 180,["201"] = 181,["202"] = 182,["203"] = 183,["205"] = 185,["207"] = 187,["208"] = 188,["209"] = 188,["210"] = 189,["211"] = 190,["212"] = 191,["214"] = 193,["217"] = 196,["219"] = 147,["220"] = 200,["221"] = 201,["222"] = 202,["223"] = 203,["225"] = 206,["226"] = 207,["227"] = 207,["228"] = 208,["229"] = 209,["230"] = 210,["232"] = 212,["233"] = 213,["234"] = 214,["235"] = 214,["236"] = 215,["237"] = 216,["238"] = 217,["240"] = 219,["241"] = 221,["242"] = 224,["243"] = 224,["244"] = 225,["245"] = 226,["246"] = 227,["248"] = 230,["249"] = 231,["250"] = 232,["251"] = 232,["252"] = 233,["253"] = 234,["254"] = 235,["256"] = 238,["257"] = 239,["258"] = 240,["259"] = 240,["260"] = 241,["261"] = 242,["262"] = 243,["263"] = 244,["265"] = 246,["267"] = 253,["268"] = 254,["269"] = 255,["270"] = 256,["271"] = 257,["272"] = 258,["273"] = 259,["274"] = 260,["276"] = 262,["277"] = 263,["278"] = 265,["279"] = 265,["280"] = 267,["281"] = 268,["282"] = 269,["283"] = 270,["285"] = 272,["287"] = 274,["288"] = 276,["289"] = 278,["290"] = 279,["292"] = 283,["293"] = 284,["294"] = 285,["295"] = 285,["296"] = 286,["297"] = 287,["298"] = 288,["299"] = 289,["300"] = 290,["301"] = 291,["302"] = 292,["304"] = 294,["306"] = 296,["308"] = 298,["309"] = 299,["310"] = 300,["311"] = 301,["312"] = 302,["314"] = 304,["316"] = 306,["317"] = 201,["318"] = 144,["319"] = 314,["320"] = 316,["321"] = 317,["322"] = 318,["325"] = 322,["326"] = 323,["327"] = 325,["328"] = 326,["329"] = 326,["330"] = 326,["331"] = 326,["332"] = 327,["333"] = 328,["334"] = 329,["335"] = 330,["336"] = 330,["337"] = 330,["338"] = 330,["339"] = 331,["340"] = 332,["342"] = 317,["343"] = 337,["344"] = 338,["345"] = 339,["346"] = 340,["348"] = 343,["349"] = 344,["350"] = 344,["351"] = 346,["352"] = 347,["353"] = 347,["355"] = 350,["356"] = 338,["357"] = 353,["358"] = 354,["359"] = 355,["360"] = 355,["361"] = 355,["363"] = 356,["364"] = 356,["365"] = 357,["366"] = 358,["367"] = 360,["368"] = 361,["369"] = 362,["370"] = 363,["372"] = 365,["373"] = 366,["374"] = 368,["376"] = 372,["377"] = 373,["378"] = 374,["380"] = 376,["381"] = 377,["382"] = 379,["385"] = 356,["388"] = 355,["389"] = 355,["390"] = 314});
local ____exports = {}
local ____AttributeUtil = require("solar.solar-common.util.system.AttributeUtil")
local AttributeUtil = ____AttributeUtil.default
local ____UnitUtil = require("solar.solar-common.util.unit.UnitUtil")
local UnitUtil = ____UnitUtil.default
local ____HeroUtil = require("solar.solar-common.util.unit.HeroUtil")
local HeroUtil = ____HeroUtil.default
local ____NativeFrameUtil = require("solar.solar-common.util.frame.NativeFrameUtil")
local NativeFrameUtil = ____NativeFrameUtil.default
local ____TextUtil = require("solar.solar-common.util.text.TextUtil")
local TextUtil = ____TextUtil.default
local ____SingletonUtil = require("solar.solar-common.util.lang.SingletonUtil")
local SingletonUtil = ____SingletonUtil.default
local ____UnitStateUtil = require("solar.solar-common.util.unit.UnitStateUtil")
local UnitStateUtil = ____UnitStateUtil.default
local ____MathUtil = require("solar.solar-common.util.math.MathUtil")
local MathUtil = ____MathUtil.default
--- PS: 此类使用局限性很大。 对魔兽不熟悉的作者请不要使用此类制作大数值，以免被无穷的各种问题折磨。
-- 
-- 模拟属性(支持大数值 注意部分魔兽原生实数数值的上限为340涧 但是lua层的数字可以达到 1e+308 如果不进魔兽层的计算可以超大数值计算)
-- 
-- 此状态下各种属性均使用自定义变量存储。所有修改属性的 均使用代码来修改 通过原生物品属性书 或等级升级奖励的属性值将不可用
-- 
-- 通过自定义实数number类型 存储数值
-- 
-- 在魔兽原本的设置属性和获取属性  走自定义属性值
-- 
-- 如果超过上限 则底层设置到限制值 属性值走自定义变量存储  显示时需自行需自行用UI显示这些大值
-- 
-- 注意：在大数值模式下一些方法计算并不严谨和准确 如果对数值扣的很细很准 请不要做大数值！
-- （在大属性模式下 不能斤斤计较）
-- link solar_attribute.d.ts ArmorReducesDamageFactor
local BaseAttributeMax = 10000000
local BaseRealMax = 8e+37
____exports.default = __TS__Class()
local BigAttributeCompatibleState = ____exports.default
BigAttributeCompatibleState.name = "BigAttributeCompatibleState"
function BigAttributeCompatibleState.prototype.____constructor(self)
    if SingletonUtil:notFirstTime(____exports.default) then
        print("不能重复new BigAttributeCompatibleState()")
        return
    end
    isBigAttributeMode = true
    self:playerAttributeCompatible()
    self:unitAttributeCompatible()
    self:heroAttributeCompatible()
    self:damageCompatible()
end
function BigAttributeCompatibleState.prototype.damageCompatible(self)
    local oldUnitDamageTarget = UnitDamageTarget
    _G.UnitDamageTarget = function(whichUnit, target, amount, attack, ranged, attackType, damageType, weaponType)
        gv._sl_lastDamage = amount
        return oldUnitDamageTarget(
            whichUnit,
            target,
            amount,
            attack,
            ranged,
            attackType,
            damageType,
            weaponType
        )
    end
end
function BigAttributeCompatibleState.prototype.heroAttributeCompatible(self)
    local oldSetHeroStr = SetHeroStr
    _G.SetHeroStr = function(whichHero, newStr, permanent)
        if not IsHandle(whichHero) then
            return
        end
        oldSetHeroStr(
            whichHero,
            MathUtil.clamp(newStr, -BaseAttributeMax, BaseAttributeMax),
            permanent
        )
        AttributeUtil:getUnitAttribute(whichHero, true)._SL_BA_str = newStr
        if StrHpBonus > 0 and newStr > BaseAttributeMax then
            local addHp = (newStr - BaseAttributeMax) * StrHpBonus
            UnitUtil.setExtraHp(whichHero, addHp, "_SL_SetHeroStr")
        end
    end
    local oldSetHeroAgi = SetHeroAgi
    _G.SetHeroAgi = function(whichHero, newAgi, permanent)
        if not IsHandle(whichHero) then
            return
        end
        oldSetHeroAgi(
            whichHero,
            MathUtil.clamp(newAgi, -BaseAttributeMax, BaseAttributeMax),
            permanent
        )
        AttributeUtil:getUnitAttribute(whichHero, true)._SL_BA_agi = newAgi
    end
    local oldSetHeroInt = SetHeroInt
    _G.SetHeroInt = function(whichHero, newInt, permanent)
        if not IsHandle(whichHero) then
            return
        end
        oldSetHeroInt(
            whichHero,
            MathUtil.clamp(newInt, -BaseAttributeMax, BaseAttributeMax),
            permanent
        )
        AttributeUtil:getUnitAttribute(whichHero, true)._SL_BA_int = newInt
        if IntManaBonus > 0 and newInt > BaseAttributeMax then
            UnitUtil.setExtraMana(whichHero, (newInt - BaseAttributeMax) * IntManaBonus, "_SL_SetHeroInt")
        end
    end
    local oldGetHeroStr = GetHeroStr
    _G.GetHeroStr = function(whichHero, includeBonuses)
        if not IsHandle(whichHero) then
            return 0
        end
        local ____opt_0 = AttributeUtil:getUnitAttribute(whichHero)
        local val = ____opt_0 and ____opt_0._SL_BA_str or oldGetHeroStr(whichHero, false)
        if includeBonuses then
            val = val + UnitUtil.getExtraStr(whichHero)
        end
        return val
    end
    local oldGetHeroAgi = GetHeroAgi
    _G.GetHeroAgi = function(whichHero, includeBonuses)
        if not IsHandle(whichHero) then
            return 0
        end
        local ____opt_2 = AttributeUtil:getUnitAttribute(whichHero)
        local val = ____opt_2 and ____opt_2._SL_BA_agi or oldGetHeroAgi(whichHero, false)
        if includeBonuses then
            val = val + UnitUtil.getExtraAgi(whichHero)
        end
        return val
    end
    local oldGetHeroInt = GetHeroInt
    _G.GetHeroInt = function(whichHero, includeBonuses)
        if not IsHandle(whichHero) then
            return 0
        end
        local ____opt_4 = AttributeUtil:getUnitAttribute(whichHero)
        local val = ____opt_4 and ____opt_4._SL_BA_int or oldGetHeroInt(whichHero, false)
        if includeBonuses then
            val = val + UnitUtil.getExtraInt(whichHero)
        end
        return val
    end
end
function BigAttributeCompatibleState.prototype.unitAttributeCompatible(self)
    local oldSetUnitState = SetUnitState
    _G.SetUnitState = function(whichUnit, whichUnitState, newVal)
        if not IsHandle(whichUnit) then
            return
        end
        if whichUnitState == UnitStateDamageBase then
            oldSetUnitState(
                whichUnit,
                whichUnitState,
                MathUtil.clamp(newVal, -BaseAttributeMax, BaseAttributeMax)
            )
            AttributeUtil:getUnitAttribute(whichUnit, true)._SL_BA_damage_base = newVal
        elseif whichUnitState == UnitStateArmor then
            oldSetUnitState(
                whichUnit,
                whichUnitState,
                MathUtil.clamp(newVal, -BaseAttributeMax, BaseAttributeMax)
            )
            AttributeUtil:getUnitAttribute(whichUnit, true)._SL_BA_armor = newVal
        elseif whichUnitState == UNIT_STATE_MAX_LIFE then
            if isDebug and newVal < 0 then
                log.errorWithTraceBack("不能对单位设置负数最大生命值!")
            end
            if newVal > BaseRealMax then
                oldSetUnitState(
                    whichUnit,
                    whichUnitState,
                    MathUtil.min(BaseRealMax, newVal)
                )
                AttributeUtil:getUnitAttribute(whichUnit, true)._SL_BA_max_life = newVal
            else
                oldSetUnitState(whichUnit, whichUnitState, newVal)
            end
        elseif whichUnitState == UNIT_STATE_MAX_MANA then
            if isDebug and newVal < 0 then
                log.errorWithTraceBack("不能对单位设置负数最大魔法值值!")
            end
            if newVal > BaseRealMax then
                oldSetUnitState(
                    whichUnit,
                    whichUnitState,
                    MathUtil.min(BaseRealMax, newVal)
                )
                AttributeUtil:getUnitAttribute(whichUnit, true)._SL_BA_max_mana = newVal
            else
                oldSetUnitState(whichUnit, whichUnitState, newVal)
            end
        elseif whichUnitState == UNIT_STATE_LIFE then
            local ____opt_6 = AttributeUtil:getUnitAttribute(whichUnit, false)
            local _SL_BA_max_life = ____opt_6 and ____opt_6._SL_BA_max_life
            if _SL_BA_max_life and _SL_BA_max_life > BaseRealMax then
                local moNiLife = newVal / _SL_BA_max_life * BaseRealMax
                oldSetUnitState(whichUnit, whichUnitState, moNiLife)
            else
                oldSetUnitState(whichUnit, whichUnitState, newVal)
            end
        elseif whichUnitState == UNIT_STATE_MANA then
            local ____opt_8 = AttributeUtil:getUnitAttribute(whichUnit, false)
            local _SL_BA_max_mana = ____opt_8 and ____opt_8._SL_BA_max_mana
            if _SL_BA_max_mana and _SL_BA_max_mana > BaseRealMax then
                local moNiMana = newVal / _SL_BA_max_mana * BaseRealMax
                oldSetUnitState(whichUnit, whichUnitState, moNiMana)
            else
                oldSetUnitState(whichUnit, whichUnitState, newVal)
            end
        else
            oldSetUnitState(whichUnit, whichUnitState, newVal)
        end
    end
    local oldGetUnitState = GetUnitState
    _G.GetUnitState = function(whichUnit, whichUnitState)
        if not IsHandle(whichUnit) then
            return 0
        end
        if whichUnitState == UNIT_STATE_MAX_LIFE then
            local ____opt_10 = AttributeUtil:getUnitAttribute(whichUnit)
            local val = ____opt_10 and ____opt_10._SL_BA_max_life
            if val == nil then
                local ba = oldGetUnitState(whichUnit, whichUnitState)
                return ba
            end
            return val
        elseif whichUnitState == UNIT_STATE_MAX_MANA then
            local ____opt_12 = AttributeUtil:getUnitAttribute(whichUnit)
            local val = ____opt_12 and ____opt_12._SL_BA_max_mana
            if val == nil then
                local ba = oldGetUnitState(whichUnit, whichUnitState)
                return ba
            end
            return val
        elseif whichUnitState == UNIT_STATE_LIFE then
            local ____opt_14 = AttributeUtil:getUnitAttribute(whichUnit, false)
            local _SL_BA_max_life = ____opt_14 and ____opt_14._SL_BA_max_life
            if _SL_BA_max_life == nil or _SL_BA_max_life < BaseRealMax then
                local ba = oldGetUnitState(whichUnit, whichUnitState)
                return ba
            end
            return oldGetUnitState(whichUnit, whichUnitState) / BaseRealMax * _SL_BA_max_life
        elseif whichUnitState == UNIT_STATE_MANA then
            local ____opt_16 = AttributeUtil:getUnitAttribute(whichUnit, false)
            local _SL_BA_max_mana = ____opt_16 and ____opt_16._SL_BA_max_mana
            if _SL_BA_max_mana == nil or _SL_BA_max_mana < BaseRealMax then
                local ba = oldGetUnitState(whichUnit, whichUnitState)
                return ba
            end
            return oldGetUnitState(whichUnit, whichUnitState) / BaseRealMax * _SL_BA_max_mana
        elseif whichUnitState == UnitStateDamageBase then
            local ____opt_18 = AttributeUtil:getUnitAttribute(whichUnit)
            local val = ____opt_18 and ____opt_18._SL_BA_damage_base
            if val == nil then
                local ba = oldGetUnitState(whichUnit, whichUnitState)
                if UnitStateUtil:isAlive(whichUnit) then
                    AttributeUtil:getUnitAttribute(whichUnit, true)._SL_BA_damage_base = ba
                end
                return ba
            end
            return val
        elseif whichUnitState == UnitStateDamageBonus then
            local val = UnitUtil.getExtraAttack(whichUnit)
            if HeroUtil:isHero(whichUnit) then
                local primaryAndBonusValue = HeroUtil:getHeroPrimaryValue(whichUnit, true)
                local primaryValue = HeroUtil:getHeroPrimaryValue(whichUnit, false)
                local primaryBonusValue = primaryAndBonusValue - primaryValue
                val = val + primaryBonusValue * PrimaryAttackBonus
            end
            return val
        elseif whichUnitState == UnitStateArmor then
            local ____opt_20 = AttributeUtil:getUnitAttribute(whichUnit)
            local val = ____opt_20 and ____opt_20._SL_BA_armor
            if val == nil then
                local ba = oldGetUnitState(whichUnit, whichUnitState)
                if UnitStateUtil:isAlive(whichUnit) then
                    AttributeUtil:getUnitAttribute(whichUnit, true)._SL_BA_armor = ba - UnitUtil.getExtraDef(whichUnit)
                end
                return ba
            end
            val = val + UnitUtil.getExtraDef(whichUnit)
            if HeroUtil:isHero(whichUnit) and AgiDefenseBonus > 0 then
                local primaryAndBonusValue = GetHeroAgi(whichUnit, true)
                val = val + primaryAndBonusValue * AgiDefenseBonus
            end
            return val
        elseif whichUnitState == UnitStateDamageMix or whichUnitState == UnitStateDamageMax then
            local ____opt_22 = AttributeUtil:getUnitAttribute(whichUnit)
            local val = ____opt_22 and ____opt_22._SL_BA_damage_base
            if val == nil then
                local ba = oldGetUnitState(whichUnit, UnitStateDamageBase)
                if UnitStateUtil:isAlive(whichUnit) then
                    if HeroUtil:isHero(whichUnit) then
                        local primaryAndBonusValue = HeroUtil:getHeroPrimaryValue(whichUnit, true)
                        val = primaryAndBonusValue * PrimaryAttackBonus
                        ba = ba - val
                    end
                    AttributeUtil:getUnitAttribute(whichUnit, true)._SL_BA_damage_base = ba
                end
                return ba
            end
            local extVal = UnitUtil.getExtraAttack(whichUnit)
            val = val + extVal
            if HeroUtil:isHero(whichUnit) then
                local primaryAndBonusValue = HeroUtil:getHeroPrimaryValue(whichUnit, true)
                val = val + primaryAndBonusValue * PrimaryAttackBonus
            end
            return val
        end
        return oldGetUnitState(whichUnit, whichUnitState)
    end
end
function BigAttributeCompatibleState.prototype.playerAttributeCompatible(self)
    local oldSetPlayerState = SetPlayerState
    _G.SetPlayerState = function(whichPlayer, whichPlayerState, value)
        if not IsHandle(whichPlayer) then
            return
        end
        local temp = math.min(value, 1000000)
        oldSetPlayerState(whichPlayer, whichPlayerState, temp)
        if whichPlayerState == PLAYER_STATE_RESOURCE_GOLD then
            DzFrameSetText(
                NativeFrameUtil:getGoldText(),
                TextUtil:toCnUnit(value)
            )
            AttributeUtil:getPlayerAttribute(whichPlayer, true)._SL_BA_gold = value
            AttributeUtil:getPlayerAttribute(whichPlayer, true)._SL_BA_gold_temp = temp
        elseif whichPlayerState == PLAYER_STATE_RESOURCE_LUMBER then
            DzFrameSetText(
                NativeFrameUtil:getLumberText(),
                TextUtil:toCnUnit(value)
            )
            AttributeUtil:getPlayerAttribute(whichPlayer, true)._SL_BA_lumber = value
            AttributeUtil:getPlayerAttribute(whichPlayer, true)._SL_BA_lumber_temp = temp
        end
    end
    local oldGetPlayerState = GetPlayerState
    _G.GetPlayerState = function(whichPlayer, whichPlayerState)
        if not IsHandle(whichPlayer) then
            return 0
        end
        if whichPlayerState == PLAYER_STATE_RESOURCE_GOLD then
            local ____opt_24 = AttributeUtil:getPlayerAttribute(whichPlayer)
            return ____opt_24 and ____opt_24._SL_BA_gold or oldGetPlayerState(whichPlayer, whichPlayerState)
        elseif whichPlayerState == PLAYER_STATE_RESOURCE_LUMBER then
            local ____opt_26 = AttributeUtil:getPlayerAttribute(whichPlayer)
            return ____opt_26 and ____opt_26._SL_BA_lumber or oldGetPlayerState(whichPlayer, whichPlayerState)
        end
        return oldGetPlayerState(whichPlayer, whichPlayerState)
    end
    local updateTrigger = CreateTrigger()
    TriggerRegisterTimerEvent(updateTrigger, 1, true)
    TriggerAddAction(
        updateTrigger,
        function()
            do
                local i = 0
                while i < bj_MAX_PLAYER_SLOTS do
                    local player = Player(i)
                    if GetPlayerController(player) == MAP_CONTROL_USER and GetPlayerSlotState(player) == PLAYER_SLOT_STATE_PLAYING then
                        local playerAttribute = AttributeUtil:getPlayerAttribute(player, true)
                        local nowTempGold = oldGetPlayerState(player, PLAYER_STATE_RESOURCE_GOLD)
                        if not playerAttribute._SL_BA_gold or not playerAttribute._SL_BA_gold_temp then
                            playerAttribute._SL_BA_gold_temp = nowTempGold
                        else
                            local add = nowTempGold - playerAttribute._SL_BA_gold_temp
                            playerAttribute._SL_BA_gold = playerAttribute._SL_BA_gold + add
                            SetPlayerState(player, PLAYER_STATE_RESOURCE_GOLD, playerAttribute._SL_BA_gold)
                        end
                        local nowTempLumber = oldGetPlayerState(player, PLAYER_STATE_RESOURCE_LUMBER)
                        if not playerAttribute._SL_BA_lumber or not playerAttribute._SL_BA_lumber_temp then
                            playerAttribute._SL_BA_lumber_temp = nowTempLumber
                        else
                            local addL = nowTempLumber - playerAttribute._SL_BA_lumber_temp
                            playerAttribute._SL_BA_lumber = playerAttribute._SL_BA_lumber + addL
                            SetPlayerState(player, PLAYER_STATE_RESOURCE_LUMBER, playerAttribute._SL_BA_lumber)
                        end
                    end
                    i = i + 1
                end
            end
        end
    )
end
return ____exports
