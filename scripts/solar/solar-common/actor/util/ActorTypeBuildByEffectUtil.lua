local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__New = ____lualib.__TS__New
local __TS__StringSplit = ____lualib.__TS__StringSplit
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["8"] = 1,["9"] = 1,["10"] = 2,["11"] = 2,["12"] = 3,["13"] = 3,["14"] = 4,["15"] = 4,["16"] = 5,["17"] = 5,["18"] = 6,["19"] = 6,["20"] = 7,["21"] = 7,["22"] = 8,["23"] = 8,["24"] = 9,["25"] = 9,["26"] = 10,["27"] = 10,["28"] = 11,["29"] = 11,["30"] = 12,["31"] = 12,["32"] = 13,["33"] = 13,["34"] = 14,["35"] = 14,["36"] = 15,["37"] = 15,["38"] = 16,["39"] = 16,["40"] = 17,["41"] = 17,["42"] = 31,["43"] = 31,["44"] = 31,["46"] = 31,["47"] = 65,["48"] = 66,["49"] = 66,["50"] = 66,["51"] = 67,["52"] = 68,["53"] = 69,["54"] = 70,["55"] = 70,["56"] = 70,["57"] = 70,["58"] = 70,["59"] = 70,["60"] = 70,["61"] = 70,["63"] = 81,["64"] = 81,["65"] = 81,["66"] = 81,["67"] = 81,["68"] = 81,["69"] = 81,["70"] = 81,["71"] = 81,["72"] = 81,["73"] = 81,["74"] = 81,["75"] = 94,["76"] = 95,["77"] = 95,["78"] = 95,["79"] = 95,["80"] = 96,["81"] = 97,["82"] = 97,["83"] = 97,["84"] = 97,["85"] = 97,["86"] = 98,["88"] = 100,["89"] = 101,["90"] = 101,["91"] = 101,["92"] = 101,["93"] = 101,["94"] = 102,["96"] = 104,["97"] = 105,["98"] = 105,["99"] = 105,["100"] = 105,["101"] = 105,["102"] = 106,["104"] = 108,["105"] = 109,["107"] = 111,["108"] = 95,["109"] = 112,["110"] = 113,["111"] = 114,["112"] = 114,["113"] = 114,["114"] = 114,["116"] = 116,["117"] = 117,["118"] = 117,["119"] = 117,["120"] = 117,["122"] = 119,["123"] = 120,["124"] = 120,["125"] = 120,["126"] = 120,["128"] = 122,["129"] = 122,["131"] = 95,["132"] = 95,["133"] = 125,["134"] = 66,["135"] = 66,["136"] = 65,["137"] = 137,["138"] = 138,["139"] = 139,["142"] = 142,["143"] = 144,["144"] = 145,["145"] = 146,["148"] = 149,["149"] = 150,["150"] = 151,["151"] = 152,["152"] = 153,["153"] = 154,["156"] = 158,["157"] = 159,["158"] = 160,["160"] = 170,["161"] = 171,["162"] = 172,["163"] = 173,["165"] = 175,["167"] = 177,["168"] = 179,["169"] = 180,["170"] = 181,["171"] = 182,["172"] = 183,["174"] = 186,["175"] = 187,["176"] = 188,["177"] = 189,["178"] = 189,["179"] = 189,["180"] = 190,["181"] = 191,["182"] = 192,["183"] = 193,["184"] = 193,["185"] = 193,["186"] = 193,["187"] = 193,["188"] = 195,["189"] = 197,["191"] = 200,["193"] = 202,["194"] = 203,["195"] = 203,["196"] = 203,["197"] = 203,["198"] = 205,["200"] = 208,["201"] = 209,["202"] = 209,["203"] = 209,["204"] = 209,["206"] = 211,["207"] = 213,["208"] = 214,["209"] = 214,["210"] = 214,["211"] = 214,["212"] = 215,["213"] = 215,["214"] = 215,["215"] = 215,["216"] = 216,["218"] = 218,["219"] = 189,["220"] = 189,["221"] = 220,["222"] = 179,["223"] = 222,["224"] = 225,["225"] = 226,["226"] = 227,["227"] = 228,["229"] = 222,["230"] = 137,["231"] = 241,["232"] = 242,["233"] = 243,["234"] = 244,["235"] = 241,["236"] = 251,["237"] = 252,["240"] = 255,["241"] = 259,["242"] = 259,["243"] = 259,["244"] = 260,["245"] = 261,["246"] = 262,["247"] = 263,["248"] = 266,["249"] = 267,["250"] = 268,["253"] = 271,["254"] = 272,["255"] = 273,["256"] = 274,["257"] = 275,["258"] = 275,["259"] = 275,["260"] = 275,["261"] = 275,["262"] = 275,["263"] = 275,["265"] = 277,["266"] = 277,["267"] = 277,["268"] = 277,["269"] = 277,["270"] = 277,["271"] = 277,["273"] = 279,["275"] = 280,["276"] = 280,["278"] = 280,["280"] = 281,["281"] = 281,["284"] = 283,["285"] = 283,["286"] = 283,["287"] = 283,["288"] = 283,["289"] = 283,["290"] = 283,["292"] = 285,["293"] = 287,["294"] = 288,["295"] = 289,["296"] = 289,["297"] = 289,["298"] = 289,["301"] = 259,["302"] = 259,["303"] = 251,["304"] = 297,["305"] = 298,["306"] = 299,["307"] = 300,["308"] = 300,["309"] = 300,["310"] = 301,["311"] = 302,["312"] = 303,["313"] = 304,["315"] = 300,["316"] = 300,["317"] = 300,["318"] = 300,["319"] = 297,["320"] = 319,["321"] = 320,["322"] = 321,["325"] = 324,["326"] = 326,["327"] = 328,["329"] = 330,["330"] = 330,["331"] = 331,["332"] = 333,["333"] = 334,["334"] = 335,["335"] = 336,["336"] = 338,["337"] = 339,["339"] = 341,["340"] = 343,["341"] = 343,["342"] = 343,["343"] = 343,["344"] = 343,["345"] = 345,["346"] = 330,["350"] = 348,["351"] = 348,["352"] = 349,["353"] = 349,["354"] = 349,["355"] = 349,["356"] = 349,["357"] = 348,["360"] = 319,["361"] = 360,["362"] = 360,["363"] = 360,["365"] = 361,["366"] = 362,["367"] = 363,["368"] = 364,["369"] = 365,["370"] = 366,["372"] = 368,["373"] = 360,["374"] = 33,["375"] = 34,["376"] = 35,["377"] = 40,["378"] = 52,["379"] = 40,["380"] = 57,["381"] = 249,["382"] = 312});
local ____exports = {}
local ____Actor = require("solar.solar-common.actor.Actor")
local Actor = ____Actor.default
local ____ObjectDataUtil = require("solar.solar-common.util.object.ObjectDataUtil")
local ObjectDataUtil = ____ObjectDataUtil.default
local ____BaseUtil = require("solar.solar-common.util.BaseUtil")
local BaseUtil = ____BaseUtil.default
local ____CameraUtil = require("solar.solar-common.util.game.CameraUtil")
local CameraUtil = ____CameraUtil.default
local ____GameUtil = require("solar.solar-common.util.game.GameUtil")
local GameUtil = ____GameUtil.default
local ____AbilityUtil = require("solar.solar-common.util.ability.AbilityUtil")
local AbilityUtil = ____AbilityUtil.default
local ____ActorUnit = require("solar.solar-common.actor.ActorUnit")
local ActorUnit = ____ActorUnit.default
local ____ActorTypeUtil = require("solar.solar-common.actor.util.ActorTypeUtil")
local ActorTypeUtil = ____ActorTypeUtil.default
local ____PlayerUtil = require("solar.solar-common.util.game.PlayerUtil")
local PlayerUtil = ____PlayerUtil.default
local ____Cache = require("solar.solar-common.tool.Cache")
local Cache = ____Cache.default
local ____SolarBuildEffect = require("solar.solar-common.tool.SolarBuildEffect")
local SolarBuildEffect = ____SolarBuildEffect.default
local ____SyncUtil = require("solar.solar-common.util.net.SyncUtil")
local SyncUtil = ____SyncUtil.default
local ____TextTagUtil = require("solar.solar-common.util.text.TextTagUtil")
local TextTagUtil = ____TextTagUtil.default
local ____UnitStateUtil = require("solar.solar-common.util.unit.UnitStateUtil")
local UnitStateUtil = ____UnitStateUtil.default
local ____ActorAbility = require("solar.solar-common.actor.ActorAbility")
local ActorAbility = ____ActorAbility.default
local ____DataBase = require("solar.solar-common.common.DataBase")
local DataBase = ____DataBase.default
local ____ObjectTemplateUtil = require("solar.solar-common.util.object.ObjectTemplateUtil")
local ObjectTemplateUtil = ____ObjectTemplateUtil.default
____exports.default = __TS__Class()
local ActorTypeBuildByEffectUtil = ____exports.default
ActorTypeBuildByEffectUtil.name = "ActorTypeBuildByEffectUtil"
function ActorTypeBuildByEffectUtil.prototype.____constructor(self)
end
function ActorTypeBuildByEffectUtil.warpUnit2BuildAbility(self, unitIdOrActorId, onLocalClickCheck, onBuild)
    return ____exports.default.cache:get(
        "warpUnit2BuildAbility:" .. unitIdOrActorId,
        function()
            local actorTypeId = "_sl_BuildAbility:" .. unitIdOrActorId
            local unitActorType = ActorTypeUtil:getActorType(unitIdOrActorId)
            if unitActorType == nil then
                unitActorType = {
                    name = ObjectDataUtil:getUnitName(unitIdOrActorId),
                    icon = ObjectDataUtil:getUnitArt(unitIdOrActorId),
                    describe = ObjectDataUtil:getUnitDataString(unitIdOrActorId, "Ubertip"),
                    goldCost = ObjectDataUtil:getUnitGoldCost(unitIdOrActorId),
                    lumberCost = ObjectDataUtil:getUnitDataNumber(unitIdOrActorId, "lumbercost"),
                    foodCost = ObjectDataUtil:getUnitDataNumber(unitIdOrActorId, "fused")
                }
            end
            local actorType = {
                id = actorTypeId,
                class = ____exports.default._sl_baseUnitBuildAbilityClass,
                name = unitActorType.name or unitIdOrActorId,
                icon = unitActorType.icon,
                describe = unitActorType.describe,
                goldCost = unitActorType.goldCost,
                lumberCost = unitActorType.lumberCost,
                foodCost = unitActorType.foodCost,
                passive = false,
                maxCd = 0
            }
            ActorTypeUtil:registerActorType(actorType)
            ____exports.default:addBuildUnitType(
                actorTypeId,
                unitIdOrActorId,
                function(____, actor)
                    if PlayerUtil:getGold(GetOwningPlayer(actor.unit)) < (actorType.goldCost or 0) then
                        PlayerUtil:message(
                            "|cffff0000金币不足!",
                            10,
                            GetOwningPlayer(actor.unit)
                        )
                        return false
                    end
                    if PlayerUtil:getLumber(GetOwningPlayer(actor.unit)) < (actorType.lumberCost or 0) then
                        PlayerUtil:message(
                            "|cffff0000木材不足!",
                            10,
                            GetOwningPlayer(actor.unit)
                        )
                        return false
                    end
                    if PlayerUtil:getFoodCapLeft(GetOwningPlayer(actor.unit)) < (actorType.foodCost or 0) then
                        PlayerUtil:message(
                            "|cffff0000人口不足!",
                            10,
                            GetOwningPlayer(actor.unit)
                        )
                        return false
                    end
                    if onLocalClickCheck then
                        return onLocalClickCheck(nil, actor)
                    end
                    return true
                end,
                function(____, actor)
                    if actorType.goldCost then
                        PlayerUtil:addGoldState(
                            GetOwningPlayer(actor.unit),
                            -actorType.goldCost
                        )
                    end
                    if actorType.lumberCost then
                        PlayerUtil:addLumberState(
                            GetOwningPlayer(actor.unit),
                            -actorType.lumberCost
                        )
                    end
                    if actorType.foodCost then
                        PlayerUtil:addFoodUsedState(
                            GetOwningPlayer(actor.unit),
                            -actorType.foodCost
                        )
                    end
                    if onBuild ~= nil then
                        onBuild(nil, actor)
                    end
                end
            )
            return actorType
        end
    )
end
function ActorTypeBuildByEffectUtil.addBuildUnitType(self, actorTypeId, unitId, onLocalClickCheck, onBuildFinish)
    if not isEmbedJapi then
        print("无内置不支持此模拟建造方法!")
        return
    end
    ____exports.default:_sl_initBuildUnit()
    local actorType = ActorTypeUtil:getActorType(actorTypeId)
    if actorType == nil then
        log.errorWithTraceBack("请先注册此类型:" .. tostring(actorType))
        return
    end
    actorType.targetType = "点"
    actorType.area = 0
    actorType.buildUnitTypeId = unitId
    actorType.onBuildFinish = onBuildFinish
    if actorType.onCreated or actorType.onLocalClick or actorType.onAction then
        log.errorWithTraceBack("必须是空事件的模板才能注册模拟建造事件")
        return
    end
    if ____exports.default.tempSolarBuildEffect == nil then
        ____exports.default.tempSolarBuildEffect = __TS__New(SolarBuildEffect)
        ____exports.default.tempSolarBuildEffect:setVisible(false)
    end
    local modelPath = nil
    local unitActorType = ActorTypeUtil:getActorType(unitId)
    if unitActorType ~= nil then
        modelPath = unitActorType.model
    else
        modelPath = ObjectDataUtil:getStandardModelPath(ObjectDataUtil:getUnitFile(unitId))
    end
    actorType._real_modelPath = modelPath
    actorType.onLocalClick = function(____, actor)
        local ccF = onLocalClickCheck and onLocalClickCheck(nil, actor)
        print("ccF=" .. tostring(ccF))
        if ccF == false then
            return false
        end
        ____exports.default.tempSolarBuildEffect:setVisible(true)
        ____exports.default.tempSolarBuildEffect:setBuildEffectModelPath(actorType._real_modelPath)
        ____exports.default.tempSolarBuildEffect:setVisible(true)
        actor.sTimer = BaseUtil.onTimer(
            0.05,
            function(____, count)
                ____exports.default.tempSolarBuildEffect:setVisible(true)
                local wordXY = CameraUtil:getWordCoordinates()
                wordXY = ____exports.default:getBuildXY(wordXY.x, wordXY.y)
                ____exports.default.tempSolarBuildEffect:setBuildXY(
                    wordXY.x,
                    wordXY.y,
                    GameUtil:getTerrainHeight(wordXY.x, wordXY.y)
                )
                if ____exports.default:canBuildCheck(actor, wordXY.x, wordXY.y) then
                    ____exports.default.tempSolarBuildEffect:setCanBuild(true)
                else
                    ____exports.default.tempSolarBuildEffect:setCanBuild(false)
                end
                if wordXY.x == 0 and wordXY.y == 0 then
                    FrameSetModelSize(
                        FrameGetMouse(),
                        1
                    )
                    ____exports.default.tempSolarBuildEffect:setVisible(false)
                else
                    ____exports.default.tempSolarBuildEffect:setVisible(true)
                    FrameSetModelSize(
                        FrameGetMouse(),
                        0.001
                    )
                end
                if not AbilityUtil:isSelectUi() or count > 1000 then
                    ____exports.default.tempSolarBuildEffect:setVisible(false)
                    DzFrameShow(
                        FrameGetMouse(),
                        true
                    )
                    FrameSetModelSize(
                        FrameGetMouse(),
                        1
                    )
                    return false
                end
                return true
            end
        )
        return true
    end
    actorType.onAction = function(____, actor, x, y, targetUnit)
        if GetLocalPlayer() == actor.unitOwner then
            local wordXY = CameraUtil:getWordCoordinates()
            wordXY = ____exports.default:getBuildXY(wordXY.x, wordXY.y)
            SyncUtil.syncObjData("_sl_:buildUnit", {i = actor.uuid, u = actorType.id, x = wordXY.x, y = wordXY.y})
        end
    end
end
function ActorTypeBuildByEffectUtil.getBuildXY(self, x, y)
    local newX = math.floor(x / 64) * 64
    local newY = math.floor(y / 64) * 64
    return {x = newX, y = newY}
end
function ActorTypeBuildByEffectUtil._sl_initBuildUnit(self)
    if ____exports.default._sl_inited then
        return
    end
    ____exports.default._sl_inited = true
    SyncUtil.onSyncObjData(
        "_sl_:buildUnit",
        function(____, p, obj)
            local actor = Actor.allActors[obj.i]
            local actorType = ActorTypeUtil:getActorType(obj.u)
            local unitId = actorType.buildUnitTypeId
            local onBuildFinish = actorType.onBuildFinish
            local wordXY = {x = obj.x, y = obj.y}
            if not PlayerUtil:costEnoughState(p, actorType.goldCost, actorType.lumberCost) then
                TextTagUtil.text("资源不足!", actor.unit)
                return
            end
            if ____exports.default:canBuildCheck(actor, wordXY.x, wordXY.y) then
                local unitActorType = ActorTypeUtil:getActorType(unitId)
                local newUnit = nil
                if unitActorType ~= nil then
                    newUnit = __TS__New(
                        ActorUnit,
                        unitId,
                        GetOwningPlayer(actor.unit),
                        wordXY.x,
                        wordXY.y
                    ).unit
                else
                    newUnit = CreateUnit(
                        GetOwningPlayer(actor.unit),
                        unitId,
                        wordXY.x,
                        wordXY.y,
                        270
                    )
                end
                ____exports.default:showUnitBirthAnim(newUnit)
                local ____this_5
                ____this_5 = ____exports.default
                local ____opt_4 = ____this_5.onBuildFinish
                if ____opt_4 ~= nil then
                    ____opt_4(____this_5, actor, newUnit)
                end
                if onBuildFinish ~= nil then
                    onBuildFinish(nil, actor, newUnit)
                end
            else
                DisplayTimedTextToPlayer(
                    GetOwningPlayer(actor.unit),
                    0,
                    0,
                    5,
                    "|cffff0000当前点不可建造!"
                )
            end
            if isEmbedJapi then
                if GetLocalPlayer() == p then
                    ____exports.default.tempSolarBuildEffect:setVisible(false)
                    FrameSetModelSize(
                        FrameGetMouse(),
                        1
                    )
                end
            end
        end
    )
end
function ActorTypeBuildByEffectUtil.showUnitBirthAnim(self, unit)
    SetUnitAnimation(unit, "birth")
    SetUnitTimeScale(nil, 100)
    BaseUtil.runLater(
        0.1,
        function(count, maxCount)
            UnitStateUtil:setUnitLifeP(unit, 0.3 + count / maxCount * 0.7)
            if count == maxCount then
                SetUnitAnimation(unit, "stand")
                SetUnitTimeScale(nil, 1)
            end
        end,
        10,
        true
    )
end
function ActorTypeBuildByEffectUtil.setBuilds2unit(self, unit, builds)
    if not isEmbedJapi then
        print("无内置不支持此模拟建造方法!")
        return
    end
    local spellBookIdStr = ____exports.default:getBuildsMenuAbilityFromunit(unit, true)
    local tongMoListStr = ObjectDataUtil:getAbilityDataString(spellBookIdStr, "DataA")
    local tongMoIds = __TS__StringSplit(tongMoListStr, ",")
    do
        local i = 0
        while i < #builds do
            local buildUnit = builds[i + 1]
            local buildAbilityActorType = ____exports.default:warpUnit2BuildAbility(buildUnit)
            local actorAbility = __TS__New(ActorAbility, buildAbilityActorType.id)
            actorAbility.unit = unit
            actorAbility.abilityId = tongMoIds[i + 1]
            if DataBase:getUnitSolarData(unit, true)._SL_solarActorAbilitys == nil then
                DataBase:getUnitSolarData(unit, true)._SL_solarActorAbilitys = {}
            end
            DataBase:getUnitSolarData(unit, true)._SL_solarActorAbilitys[actorAbility.abilityId] = actorAbility
            SetUnitAbilityButtonShow(
                unit,
                FourCC(tongMoIds[i + 1]),
                true
            )
            actorAbility:update()
            i = i + 1
        end
    end
    do
        local i = #builds
        while i < #tongMoIds do
            SetUnitAbilityButtonShow(
                unit,
                FourCC(tongMoIds[i + 1]),
                false
            )
            i = i + 1
        end
    end
end
function ActorTypeBuildByEffectUtil.getBuildsMenuAbilityFromunit(self, unit, createDefault)
    if createDefault == nil then
        createDefault = true
    end
    local solarData = DataBase:getUnitSolarData(unit, createDefault)
    if createDefault and solarData._sl_BuildsMenuAbility == nil then
        local spellBookIdStr = ObjectTemplateUtil:borrowTemplate("建造菜单技能")
        solarData._sl_BuildsMenuAbility = spellBookIdStr
        UnitAddAbility(unit, spellBookIdStr)
        AbilityUtil:setUnitAbilityName(unit, spellBookIdStr, "建造菜单 |cffeeee00(B|r)")
    end
    return solarData._sl_BuildsMenuAbility
end
ActorTypeBuildByEffectUtil.cache = __TS__New(Cache)
ActorTypeBuildByEffectUtil.tempSolarBuildEffect = nil
ActorTypeBuildByEffectUtil._sl_baseUnitBuildAbilityClass = "太阳单位演员技能建造"
ActorTypeBuildByEffectUtil.canBuildCheck = function(____, actor, x, y)
    return not IsTerrainPathable(x, y, PATHING_TYPE_BUILDABILITY) and not IsTerrainPathable(x, y, PATHING_TYPE_WALKABILITY)
end
ActorTypeBuildByEffectUtil.onBuildFinish = nil
ActorTypeBuildByEffectUtil._sl_inited = false
ActorTypeBuildByEffectUtil.map = {}
return ____exports
