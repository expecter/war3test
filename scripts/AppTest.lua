local ____lualib = require("lualib_bundle")
local __TS__Class = ____lualib.__TS__Class
local __TS__New = ____lualib.__TS__New
local __TS__ObjectAssign = ____lualib.__TS__ObjectAssign
local __TS__SourceMapTraceBack = ____lualib.__TS__SourceMapTraceBack
__TS__SourceMapTraceBack(debug.getinfo(1).short_src, {["8"] = 1,["9"] = 1,["10"] = 2,["11"] = 2,["12"] = 3,["13"] = 3,["14"] = 4,["15"] = 4,["16"] = 5,["17"] = 5,["18"] = 6,["19"] = 6,["20"] = 6,["21"] = 7,["22"] = 7,["23"] = 8,["24"] = 8,["25"] = 9,["26"] = 9,["27"] = 10,["28"] = 10,["29"] = 11,["30"] = 11,["31"] = 12,["32"] = 12,["33"] = 13,["34"] = 13,["35"] = 14,["36"] = 14,["37"] = 15,["38"] = 15,["39"] = 16,["40"] = 16,["41"] = 17,["42"] = 17,["43"] = 18,["44"] = 18,["45"] = 19,["46"] = 19,["47"] = 20,["48"] = 20,["49"] = 21,["50"] = 21,["51"] = 22,["52"] = 22,["53"] = 25,["54"] = 25,["55"] = 25,["57"] = 28,["58"] = 29,["59"] = 30,["60"] = 31,["61"] = 32,["62"] = 32,["63"] = 32,["64"] = 33,["65"] = 32,["66"] = 32,["67"] = 35,["68"] = 35,["69"] = 35,["70"] = 36,["71"] = 35,["72"] = 35,["73"] = 38,["74"] = 38,["75"] = 38,["76"] = 39,["77"] = 38,["78"] = 38,["79"] = 41,["80"] = 41,["81"] = 41,["82"] = 42,["83"] = 43,["84"] = 44,["85"] = 44,["86"] = 44,["87"] = 45,["88"] = 44,["89"] = 44,["90"] = 43,["91"] = 48,["92"] = 48,["93"] = 48,["94"] = 49,["95"] = 48,["96"] = 48,["97"] = 52,["98"] = 54,["99"] = 52,["100"] = 56,["101"] = 58,["102"] = 56,["103"] = 60,["104"] = 61,["105"] = 60,["106"] = 41,["107"] = 41,["108"] = 66,["109"] = 68,["110"] = 68,["111"] = 69,["114"] = 73,["115"] = 74,["116"] = 75,["118"] = 77,["119"] = 77,["120"] = 77,["121"] = 77,["122"] = 77,["123"] = 77,["124"] = 77,["125"] = 68,["127"] = 27,["128"] = 83,["129"] = 84,["130"] = 85,["131"] = 83,["132"] = 89,["133"] = 90,["134"] = 91,["135"] = 90,["136"] = 93,["137"] = 94,["138"] = 95,["139"] = 93,["140"] = 97,["141"] = 97,["142"] = 97,["143"] = 98,["144"] = 97,["145"] = 97,["146"] = 89,["147"] = 106,["148"] = 107,["149"] = 107,["150"] = 107,["151"] = 108,["152"] = 109,["153"] = 109,["154"] = 109,["155"] = 109,["156"] = 109,["157"] = 109,["158"] = 109,["159"] = 109,["160"] = 110,["161"] = 110,["162"] = 110,["163"] = 110,["164"] = 110,["165"] = 110,["166"] = 110,["167"] = 110,["168"] = 111,["169"] = 112,["170"] = 113,["171"] = 107,["172"] = 107,["173"] = 117,["174"] = 119,["175"] = 119,["176"] = 119,["177"] = 120,["178"] = 119,["179"] = 119,["180"] = 123,["181"] = 125,["182"] = 125,["183"] = 125,["184"] = 126,["185"] = 126,["186"] = 126,["187"] = 127,["188"] = 128,["189"] = 126,["190"] = 126,["191"] = 131,["192"] = 131,["193"] = 131,["194"] = 132,["195"] = 133,["196"] = 131,["197"] = 131,["198"] = 125,["199"] = 125,["200"] = 106,["201"] = 138,["202"] = 139,["203"] = 139,["204"] = 139,["205"] = 140,["206"] = 141,["207"] = 141,["208"] = 141,["209"] = 141,["210"] = 141,["211"] = 141,["212"] = 141,["213"] = 141,["214"] = 142,["215"] = 142,["216"] = 142,["217"] = 143,["218"] = 145,["219"] = 146,["220"] = 147,["222"] = 149,["223"] = 150,["225"] = 152,["226"] = 153,["227"] = 154,["228"] = 155,["229"] = 156,["230"] = 158,["231"] = 159,["232"] = 160,["233"] = 160,["234"] = 160,["235"] = 160,["236"] = 165,["237"] = 165,["238"] = 165,["239"] = 165,["240"] = 165,["241"] = 165,["242"] = 165,["243"] = 165,["244"] = 165,["245"] = 165,["246"] = 165,["247"] = 165,["248"] = 177,["249"] = 178,["250"] = 160,["251"] = 181,["252"] = 182,["253"] = 142,["254"] = 142,["255"] = 139,["256"] = 139,["257"] = 138,["258"] = 188,["259"] = 189,["260"] = 190,["261"] = 191,["262"] = 192,["263"] = 193,["264"] = 194,["265"] = 195,["266"] = 195,["267"] = 195,["268"] = 195,["269"] = 195,["270"] = 195,["271"] = 195,["272"] = 194,["273"] = 199,["274"] = 199,["275"] = 199,["276"] = 200,["277"] = 200,["278"] = 200,["279"] = 200,["280"] = 200,["281"] = 200,["282"] = 200,["283"] = 199,["284"] = 199,["285"] = 203,["286"] = 204,["287"] = 203,["288"] = 188,["289"] = 209,["290"] = 210,["291"] = 211,["292"] = 212,["293"] = 213,["294"] = 214,["295"] = 215,["296"] = 217,["297"] = 218,["298"] = 218,["299"] = 218,["300"] = 218,["301"] = 218,["302"] = 218,["303"] = 218,["304"] = 212,["305"] = 220,["306"] = 221,["307"] = 222,["308"] = 223,["309"] = 224,["310"] = 227,["311"] = 221,["312"] = 209,["313"] = 231,["314"] = 234,["315"] = 235,["316"] = 235,["317"] = 235,["318"] = 235,["319"] = 236,["320"] = 237,["321"] = 237,["322"] = 237,["323"] = 237,["324"] = 237,["325"] = 237,["326"] = 237,["327"] = 238,["328"] = 238,["329"] = 238,["330"] = 238,["331"] = 238,["332"] = 239,["333"] = 239,["334"] = 239,["335"] = 238,["336"] = 238,["338"] = 241,["339"] = 241,["340"] = 241,["341"] = 241,["342"] = 241,["343"] = 243,["344"] = 243,["345"] = 243,["346"] = 243,["347"] = 243,["349"] = 231,["350"] = 249,["351"] = 250,["352"] = 250,["353"] = 250,["354"] = 252,["355"] = 253,["356"] = 255,["357"] = 256,["358"] = 257,["359"] = 258,["360"] = 259,["361"] = 260,["362"] = 250,["363"] = 250,["364"] = 249});
local ____exports = {}
local ____DebugUtil = require("solar.solar-common.util.debug.DebugUtil")
local DebugUtil = ____DebugUtil.default
local ____BaseUtil = require("solar.solar-common.util.BaseUtil")
local BaseUtil = ____BaseUtil.default
local ____unit = require("solar.solar-common.w3ts.handles.unit")
local Unit = ____unit.Unit
local ____Gui = require("Gui")
local Gui = ____Gui.default
local ____Log = require("solar.solar-wc3.common.Log")
local Log = ____Log.default
local ____tween = require("solar.solar-common.lib.tween.index")
local Easing = ____tween.Easing
local Tween = ____tween.Tween
local ____SyncUtil = require("solar.solar-common.util.net.SyncUtil")
local SyncUtil = ____SyncUtil.default
local ____frame = require("solar.solar-common.w3ts.handles.frame")
local Frame = ____frame.Frame
local ____ArchiveUtil = require("solar.solar-common.util.archive.ArchiveUtil")
local ArchiveUtil = ____ArchiveUtil.default
local ____AsyncUtil = require("solar.solar-common.util.net.AsyncUtil")
local AsyncUtil = ____AsyncUtil.default
local ____CameraUtil = require("solar.solar-common.util.game.CameraUtil")
local CameraUtil = ____CameraUtil.default
local ____InterpolationUtil = require("solar.solar-common.util.math.InterpolationUtil")
local InterpolationUtil = ____InterpolationUtil.default
local ____Vector3 = require("solar.solar-common.lib.mod.Vector3")
local Vector3 = ____Vector3.default
local ____SolarDamageState = require("solar.solar-common.attribute.SolarDamageState")
local SolarDamageState = ____SolarDamageState.default
local ____TextTagUtil = require("solar.solar-common.util.text.TextTagUtil")
local TextTagUtil = ____TextTagUtil.default
local ____DebugCheckSyncUtil = require("solar.solar-wc3.util.debug.DebugCheckSyncUtil")
local DebugCheckSyncUtil = ____DebugCheckSyncUtil.default
local ____GameUtil = require("solar.solar-common.util.game.GameUtil")
local GameUtil = ____GameUtil.default
local ____YiYiApiJassImpl = require("solar.solar-wc3.lib.compatible.yiyi.YiYiApiJassImpl")
local YiYiApiJassImpl = ____YiYiApiJassImpl.default
local ____FrameCallbackUtil = require("solar.solar-common.util.frame.FrameCallbackUtil")
local FrameCallbackUtil = ____FrameCallbackUtil.default
local ____SingletonUtil = require("solar.solar-common.util.lang.SingletonUtil")
local SingletonUtil = ____SingletonUtil.default
local ____InputUtil = require("solar.solar-common.util.system.InputUtil")
local InputUtil = ____InputUtil.default
local ____KeyCode = require("solar.solar-common.constant.KeyCode")
local KeyCode = ____KeyCode.default
____exports.default = __TS__Class()
local AppTest = ____exports.default
AppTest.name = "AppTest"
function AppTest.prototype.____constructor(self)
    if isDebug then
        GameUtil:openFullMapView()
        Cheat("greedisgood 100000")
        Cheat("warpten")
        se:playerChat(
            "se",
            function()
                self:seTest()
            end
        )
        se:playerChat(
            "cs",
            function()
                DebugCheckSyncUtil.start()
            end
        )
        se:playerChat(
            "auto",
            function()
                isAuto = true
            end
        )
        se:playerChat(
            "t11",
            function()
                YiYiApiJassImpl.init()
                FrameCallbackUtil:addFrameSetUpdateCallback(function()
                    SingletonUtil:executeOnce(
                        "1",
                        function()
                            print("on addFrameSetUpdateCallback")
                        end
                    )
                end)
                InputUtil:onKeyPressed(
                    KeyCode.VK_D,
                    function()
                        print("d 建 按下" .. tostring(DzGetTriggerKey()))
                    end
                )
                InputUtil:onMouseLeftButtonPressed(function()
                    print("左键点击" .. tostring(DzGetTriggerKey()))
                end)
                InputUtil:onMouseRightButtonPressed(function()
                    print("右键点击" .. tostring(DzGetTriggerKey()))
                end)
                InputUtil:onMouseMoveEvent(function()
                    print("onMouseMoveEvent x:" .. tostring(DzGetMouseXRelative()))
                end)
            end
        )
        self:solarTest()
        local ____SolarDamageState_config_damageEventHandlers_0 = SolarDamageState.config.damageEventHandlers
        ____SolarDamageState_config_damageEventHandlers_0[#____SolarDamageState_config_damageEventHandlers_0 + 1] = function(____, event)
            if not event.isCritical then
                return
            end
            local tag = "暴击:"
            if not event.isPhysical then
                tag = "法术" .. tag
            end
            TextTagUtil.text(
                tag .. tostring(math.floor(event.resultDamage)),
                event.unit0,
                8,
                2,
                200
            )
        end
    end
end
function AppTest.prototype.onUnitAttacked(self, triggerUnit, attacker)
    BJDebugMsg("触发单位=" .. GetUnitName(triggerUnit))
    BJDebugMsg("攻击单位=" .. GetUnitName(attacker))
end
function AppTest.prototype.seTest(self)
    se:unitAttacked(function(...)
        self:onUnitAttacked(...)
    end)
    se:unitAttacked(function(triggerUnit, attacker)
        BJDebugMsg("被攻击单位2222=" .. GetUnitName(triggerUnit))
        BJDebugMsg("攻击单位2222=" .. GetUnitName(attacker))
    end)
    se:onEnterRect(
        nil,
        function(e)
            BJDebugMsg("进入区域了=" .. GetUnitName(e.trigUnit))
        end
    )
end
function AppTest.prototype.solarTest(self)
    se:playerChat(
        "1",
        function()
            DebugUtil.showText(tostring(BaseUtil.getGameTime()) .. "")
            local unit = __TS__New(
                Unit,
                0,
                "hpea",
                0,
                0,
                0
            )
            SetUnitState(
                unit.handle,
                ConvertUnitState(18),
                500 + GetUnitState(
                    GetTriggerUnit(),
                    ConvertUnitState(18)
                ) * 100
            )
            print_r(handledef(unit.handle).reference)
            DebugUtil.printLocalVars()
            self:uiTest()
        end
    )
    self:httpJsonTest()
    DebugUtil.onChat(
        "2",
        function()
            self:archiveTest()
        end
    )
    self:w2sTest()
    DebugUtil.onChat(
        "4",
        function()
            local sTimer = BaseUtil.onTimer(
                1,
                function(____, c)
                    BJDebugMsg("太阳计时器循环执行:" .. tostring(c))
                    return true
                end
            )
            BaseUtil.runLater(
                5,
                function()
                    BJDebugMsg("手动关闭太阳计时器循环执行:" .. tostring(sTimer))
                    sTimer:destroy()
                end
            )
        end
    )
end
function AppTest.prototype.w2sTest(self)
    se:playerChat(
        "3",
        function()
            DebugUtil.showText(tostring(BaseUtil.getGameTime()) .. "测试世界坐标转屏幕坐标")
            local unit = __TS__New(
                Unit,
                0,
                "Hamg",
                0,
                0,
                0
            )
            BaseUtil.onTimer(
                0.05,
                function(____, c)
                    local screenCoordinates = CameraUtil:getScreenCoordinates(unit.x, unit.y)
                    log.debug("sc=" .. JSON:stringify(screenCoordinates))
                    if screenCoordinates.x < 0 or screenCoordinates.x > 0.8 then
                        return true
                    end
                    if screenCoordinates.y < 0 or screenCoordinates.y > 0.6 then
                        return true
                    end
                    local frame = Frame:createBackDrop()
                    frame:setTexture("ReplaceableTextures\\Selection\\SelectionCircleSmall.blp")
                    frame:setSize(0.04, 0.04)
                    screenCoordinates.x = screenCoordinates.x - 0.02
                    frame:setAbsPoint(FRAMEPOINT_TOPLEFT, screenCoordinates.x, screenCoordinates.y)
                    local toX = 0
                    local toY = 0
                    local tween = __TS__New(
                        Tween,
                        __TS__ObjectAssign({}, screenCoordinates, {p = 0, s = 0.04})
                    ):to({x = toX, y = toY, p = 1, s = 0}, 2000):easing(Easing.Quadratic.Out):onUpdate(function(____, temp)
                        local position = InterpolationUtil:bezier(
                            temp.p,
                            __TS__New(Vector3, screenCoordinates.x, screenCoordinates.y),
                            __TS__New(Vector3, 0, 0),
                            __TS__New(Vector3, 0, 0.8),
                            __TS__New(Vector3, 0.6, 0.8),
                            __TS__New(Vector3, 0.6, 0),
                            __TS__New(Vector3, 0, 0),
                            __TS__New(Vector3, 0, 0.8),
                            __TS__New(Vector3, 0.6, 0.8),
                            __TS__New(Vector3, 0.6, 0)
                        )
                        frame:setAbsPoint(FRAMEPOINT_TOPLEFT, position.x, position.y)
                        frame:setSize(temp.s, temp.s)
                    end)
                    tween:start()
                    return true
                end
            )
        end
    )
end
function AppTest.prototype.uiTest(self)
    local frame = Frame:createTEXTBUTTON()
    frame:setText("测试Frame按钮")
    frame:addBackgroundImage("ReplaceableTextures\\Selection\\SelectionCircleSmall.blp")
    frame:setSize(0.1, 0.2)
    frame:setAbsPoint(FRAMEPOINT_BOTTOMLEFT, 0.1, 0.2)
    frame:setOnClick(function()
        DisplayTimedTextToPlayer(
            GetLocalPlayer(),
            0,
            0,
            20,
            "测试Frame按钮 点击了！"
        )
    end)
    SyncUtil.onSyncData(
        "gui_test",
        function(____, p)
            DisplayTimedTextToPlayer(
                GetLocalPlayer(),
                0,
                0,
                20,
                "接收到数据同步！触发的玩家为:" .. GetPlayerName(p)
            )
        end
    )
    AsyncUtil:run(function()
        __TS__New(Gui)
    end)
end
function AppTest.prototype.hookTest(self)
    print(log.path)
    local jassCreateUnit = CreateUnit
    _G.CreateUnit = function(id, unitid, x, y, face)
        local info = (((((("你创建了单位id:" .. tostring(GetPlayerId(id))) .. " unitid=") .. tostring(unitid)) .. " x,y=") .. tostring(x)) .. ",") .. tostring(y)
        print(info)
        log.info(info)
        Log.enable = false
        return jassCreateUnit(
            id,
            unitid,
            x,
            y,
            face
        )
    end
    local jassRemoveItem = RemoveItem
    _G.RemoveItem = function(whichItem)
        local info = (("移除了物品:" .. GetItemName(whichItem)) .. " handle=") .. tostring(whichItem)
        print(info)
        log.info(info)
        jassRemoveItem(whichItem)
    end
end
function AppTest.prototype.archiveTest(self)
    local key = "key值也占用存档空间,推荐短命名比如a1,B2,C34,以及中文"
    local av = ArchiveUtil:get(
        Player(0),
        key
    )
    if av then
        DisplayTimedTextToPlayer(
            GetLocalPlayer(),
            0,
            0,
            60,
            "从存档拉出的数据是:" .. tostring(av)
        )
        DisplayTimedTextToPlayer(
            GetLocalPlayer(),
            0,
            0,
            60,
            "从存档读对象表:" .. tostring(ArchiveUtil:get(
                Player(0),
                "我存个对象"
            )["套娃"].a)
        )
    else
        ArchiveUtil:set(
            Player(0),
            key,
            "哈哈我使劲存啊，把存档占满，不用白不用！！！！，布尔值可存0跟1以节省空间。我这里其实可以存超过64个长度的字符串啊 最大可存1.9W个字符"
        )
        ArchiveUtil:set(
            Player(0),
            "我存个对象",
            {["存个整数"] = 1, ["存个布尔"] = true, ["存个字符"] = "a", ["套娃"] = {a = "我是对象里的对象的套娃a数据"}}
        )
    end
end
function AppTest.prototype.httpJsonTest(self)
    se:playerChat(
        "tj",
        function()
            local result = JSON:stringify({a = {1, {b = 2}}})
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[对象转Json字符串=]") .. tostring(result))
            result = JSON:parse("{\"a\":[1,{\"b\":2}]}")
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[Json字符串转对象=]") .. tostring(result))
            print_r(result)
            local a = result.a
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[Json字符串转对象a[0]=]") .. tostring(a[1]))
            DebugUtil.showText((tostring(BaseUtil.getGameTime()) .. "[Json字符串转对象a[1][\"b\"]=]") .. tostring(a[2].b))
        end
    )
end
return ____exports
